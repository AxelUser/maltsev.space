<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1, maximum-scale=5, viewport-fit=cover"
		/>

		<!-- Favicons -->
		<link rel="icon" type="image/png" href="../favicon-96x96.png" sizes="96x96" />
		<link rel="icon" type="image/svg+xml" href="../favicon.svg" />
		<link rel="shortcut icon" href="../favicon.ico" />
		<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png" />
		<meta name="apple-mobile-web-app-title" content="Maltsev.Space" />
		<link rel="manifest" href="../site.webmanifest" />
		
		<link href="../_app/immutable/assets/tag-cloud.BkX6IjHT.css" rel="stylesheet">
		<link href="../_app/immutable/assets/0.B79WhaIa.css" rel="stylesheet">
		<link href="../_app/immutable/assets/posts.BYtmJbQG.css" rel="stylesheet">
		<link href="../_app/immutable/assets/7.BiTSSqz6.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.By1qBRDJ.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Crl4Leb3.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C93sEKZr.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CYgJF_JY.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.GFsoqh4X.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Dp1pzeXC.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CEYJ1X-9.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/TDdWhIBO.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.DKlgUaup.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BAtPURNs.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DPOUz0k3.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/B1Lznyga.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/7.BFFe9Fu3.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DhiaSQyi.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DU7DtFm-.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/a1pPPDLw.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DNSHY1Ls.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/usYvY7N9.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/MWaUe8n8.js"><!--[--><link rel="alternate" type="application/rss+xml" title="Aleksey Maltsev's Blog" href="/rss.xml"> <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><!--]--><!--[--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css" integrity="sha384-5TcZemv2l/9On385z///+d7MSYlvIEw9FuZTIdZ14vJLqWphw7e7ZPuOiCHJcFCP" crossorigin="anonymous"><!--]--><!--[--><meta name="description" content="Craving Kotlin's secure pattern matching on sealed classes for your C# code? Discover how the Visitor Pattern can satisfy your longing!"> <link rel="canonical" href="https://maltsev.space/blog/007-fixing-csharp-type-pattern-matching"> <!--[!--><meta name="robots" content="index, follow"><!--]--> <meta property="og:type" content="article"> <meta property="og:title" content="Fixing C# type pattern-matching | MALTSEV.SPACE"> <meta property="og:description" content="Craving Kotlin's secure pattern matching on sealed classes for your C# code? Discover how the Visitor Pattern can satisfy your longing!"> <meta property="og:image" content="https://maltsev.space/images/blog/007-fixing-csharp-type-pattern-matching/hero.jpg"> <meta property="og:image:alt" content="Fixing C# type pattern-matching - Blog post hero image"> <meta property="og:url" content="https://maltsev.space/blog/007-fixing-csharp-type-pattern-matching"> <meta property="og:site_name" content="MALTSEV.SPACE"> <meta property="og:locale" content="en_US"> <!--[--><!--[--><meta property="article:published_time" content="2024-02-18T00:00:00.000Z"><!--]--> <!--[!--><!--]--> <!--[--><meta property="article:author" content="Aleksey Maltsev"><!--]--> <meta property="article:section" content="Technology"> <!--[--><meta property="article:tag" content="C#"><meta property="article:tag" content="Visitors Pattern"><meta property="article:tag" content="Type pattern matching"><meta property="article:tag" content="switch keyword"><meta property="article:tag" content="C#"><!--]--><!--]--> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:title" content="Fixing C# type pattern-matching | MALTSEV.SPACE"> <meta name="twitter:description" content="Craving Kotlin's secure pattern matching on sealed classes for your C# code? Discover how the Visitor Pattern can satisfy your longing!"> <meta name="twitter:image" content="https://maltsev.space/images/blog/007-fixing-csharp-type-pattern-matching/hero.jpg"> <meta name="twitter:image:alt" content="Fixing C# type pattern-matching - Blog post hero image"> <meta name="twitter:site" content="@axel_user"> <meta name="twitter:creator" content="@axel_user">  <!----><script type="application/ld+json">{"@context":"https://schema.org","@type":"Person","name":"Aleksey Maltsev","jobTitle":"Senior Software Engineer","description":"Senior Software Engineer focused on distributed systems and highload applications","url":"https://maltsev.space/","image":"https://maltsev.space/images/ava.jpg","sameAs":["https://github.com/AxelUser","https://www.linkedin.com/in/dev-alexey-maltsev/"]}</script><!----> <!--[!--><!--]--> <!--[--><!----><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"Fixing C# type pattern-matching","description":"Craving Kotlin's secure pattern matching on sealed classes for your C# code? Discover how the Visitor Pattern can satisfy your longing!","image":"https://maltsev.space/images/blog/007-fixing-csharp-type-pattern-matching/hero.jpg","author":{"@context":"https://schema.org","@type":"Person","name":"Aleksey Maltsev","jobTitle":"Senior Software Engineer","description":"Senior Software Engineer focused on distributed systems and highload applications","url":"https://maltsev.space/","image":"https://maltsev.space/images/ava.jpg","sameAs":["https://github.com/AxelUser","https://www.linkedin.com/in/dev-alexey-maltsev/"]},"publisher":{"@context":"https://schema.org","@type":"Person","name":"Aleksey Maltsev","jobTitle":"Senior Software Engineer","description":"Senior Software Engineer focused on distributed systems and highload applications","url":"https://maltsev.space/","image":"https://maltsev.space/images/ava.jpg","sameAs":["https://github.com/AxelUser","https://www.linkedin.com/in/dev-alexey-maltsev/"]},"url":"https://maltsev.space/blog/007-fixing-csharp-type-pattern-matching","datePublished":"2024-02-18T00:00:00.000Z","dateModified":"2024-02-18T00:00:00.000Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://maltsev.space/blog/007-fixing-csharp-type-pattern-matching"},"keywords":["C#","Visitors Pattern","Type pattern matching","switch keyword","C#"]}</script><!----><!--]--><!--]--><title>Fixing C# type pattern-matching | MALTSEV.SPACE</title>
	</head>

	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><div class="space-layout svelte-144yekp"><header class="svelte-yqzv1j"><nav class="space-container svelte-yqzv1j"><div class="logo svelte-yqzv1j"><a href="/" class="svelte-yqzv1j">MALTSEV.SPACE</a></div> <ul class="nav-links svelte-yqzv1j"><li><a class="nav-link svelte-yqzv1j" href="/">Home</a></li> <li><a class="nav-link svelte-yqzv1j" href="/about">About</a></li> <li><a class="nav-link svelte-yqzv1j" href="/art">Gallery</a></li> <li><a class="nav-link svelte-yqzv1j" href="/blog">Blog</a></li></ul> <div class="nav-actions svelte-yqzv1j"><a href="/rss.xml" class="rss-link nav-link svelte-yqzv1j" aria-label="RSS Feed"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide-icon lucide lucide-rss"><!--[--><!----><path d="M4 11a9 9 0 0 1 9 9"><!----></path><!----><!----><path d="M4 4a16 16 0 0 1 16 16"><!----></path><!----><!----><circle cx="5" cy="19" r="1"><!----></circle><!----><!--]--><!----><!----></svg><!----></a> <div class="theme-switch svelte-awph5w"><button class="theme-button svelte-awph5w" title="Light theme" aria-label="Light theme"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-icon lucide lucide-sun"><!--[--><!----><circle cx="12" cy="12" r="4"><!----></circle><!----><!----><path d="M12 2v2"><!----></path><!----><!----><path d="M12 20v2"><!----></path><!----><!----><path d="m4.93 4.93 1.41 1.41"><!----></path><!----><!----><path d="m17.66 17.66 1.41 1.41"><!----></path><!----><!----><path d="M2 12h2"><!----></path><!----><!----><path d="M20 12h2"><!----></path><!----><!----><path d="m6.34 17.66-1.41 1.41"><!----></path><!----><!----><path d="m19.07 4.93-1.41 1.41"><!----></path><!----><!--]--><!----><!----></svg><!----></button> <button class="theme-button svelte-awph5w" title="Dark theme" aria-label="Dark theme"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-icon lucide lucide-moon"><!--[--><!----><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"><!----></path><!----><!--]--><!----><!----></svg><!----></button> <button class="theme-button svelte-awph5w active" title="System theme" aria-label="System theme"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-icon lucide lucide-laptop"><!--[--><!----><path d="M20 16V7a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v9m16 0H4m16 0 1.28 2.55a1 1 0 0 1-.9 1.45H3.62a1 1 0 0 1-.9-1.45L4 16"><!----></path><!----><!--]--><!----><!----></svg><!----></button></div><!----> <button class="mobile-menu-toggle svelte-yqzv1j" aria-label="Toggle menu"><!--[!--><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide-icon lucide lucide-menu"><!--[--><!----><path d="M4 12h16"><!----></path><!----><!----><path d="M4 18h16"><!----></path><!----><!----><path d="M4 6h16"><!----></path><!----><!--]--><!----><!----></svg><!--]--></button></div></nav> <div class="mobile-nav svelte-yqzv1j"><ul class="svelte-yqzv1j"><li class="svelte-yqzv1j"><a class="nav-link svelte-yqzv1j" href="/">Home</a></li> <li class="svelte-yqzv1j"><a class="nav-link svelte-yqzv1j" href="/about">About</a></li> <li class="svelte-yqzv1j"><a class="nav-link svelte-yqzv1j" href="/art">Gallery</a></li> <li class="svelte-yqzv1j"><a class="nav-link svelte-yqzv1j" href="/blog">Blog</a></li></ul></div></header><!----> <div class="stars-background svelte-1xnwqdy"><!--[--><!--]--></div><!----> <main class="svelte-144yekp"><div class="space-container"><!----><!----> <!--[--><div class="hero-background-container svelte-yczkrf"><img src="/images/blog/007-fixing-csharp-type-pattern-matching/hero.jpg" alt="Fixing C# type pattern-matching hero image" loading="lazy" class="hero-background-image svelte-yczkrf"> <div class="hero-content svelte-yczkrf"><hgroup class="svelte-yczkrf"><div class="post-meta svelte-yczkrf"><time datetime="2024-06-15" class="publish-date svelte-yczkrf">2024-02-18</time> <span class="meta-separator svelte-yczkrf">•</span> <span class="author-name svelte-yczkrf">by Aleksey Maltsev</span></div> <h1 class="space-title">Fixing C# type pattern-matching</h1> <!--[--><p class="post-preview svelte-yczkrf">Craving Kotlin's secure pattern matching on sealed classes for your C# code? Discover how the Visitor Pattern can satisfy your longing!</p><!--]--></hgroup></div></div><!--]--> <article class="svelte-yczkrf"><!--[!--><!--]--> <div class="post-navigation top-navigation svelte-yczkrf"><!--[--><a href="/blog" class="button primary medium svelte-1edpa7d"><!---->← Back to all posts<!----></a><!--]--><!----></div> <!--[!--><!--]--> <div class="prose"><p>Hello there! Are you looking for ways to make your code more robust, maintainable, and less prone to runtime errors? Well, buckle up because today we’re going to explore how to substitute type pattern matching in C# with the Visitors pattern. Yes, I know it sounds a bit strange, but stick with me, and you’ll see how this can help you write better code.</p> <h2 id="task-example-validation-of-property-values"><a class="header-anchor" aria-hidden="true" tabindex="-1" href="#task-example-validation-of-property-values">#</a>Task example: Validation of property values</h2> <p>So let’s start with an example. Imagine we have a marker interface for some property value - <code>IValue</code>. It has two implementations - <code>StringValue</code> and <code>NumericValue</code>, holding <code>string</code> and <code>long</code> values respectively.</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> interface</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> &#123;</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> &#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> record</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> StringValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#F97583">string</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">?</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Value</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> :</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> record</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> NumericValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#F97583">long</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Value</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> :</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span></code></pre><!----> <p>As an example, let’s implement validation of those values. We write a static helper function <code>IsValid</code>, which accepts <code>IValue</code> and returns a boolean value: <code>true</code> if the value is valid, <code>false</code> otherwise. We do it in a straightforward way - just make a <code>switch</code> expression with branches for <code>StringValue</code> and <code>NumericValue</code> types. But for our <code>switch</code> to be exhaustive, we’re forced to make a default branch with throwing <code>UnreachableException</code>.</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#C792EA;--shiki-dark:#F97583"> static</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> ValidationHelper</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    public</span><span style="color:#C792EA;--shiki-dark:#F97583"> static</span><span style="color:#89DDFF;--shiki-dark:#F97583"> bool</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> IsValid</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">IValue</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> value</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#123;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">        return</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> value </span><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">switch</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">        &#123;</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#B392F0">            StringValue</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> stringValue</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span><span style="color:#89DDFF;--shiki-dark:#F97583"> !</span><span style="color:#89DDFF;--shiki-dark:#F97583">string</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">IsNullOrWhiteSpace</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">stringValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">Value</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#B392F0">            NumericValue</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> numericValue</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> numericValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">Value </span><span style="color:#89DDFF;--shiki-dark:#F97583">>=</span><span style="color:#F78C6C;--shiki-dark:#79B8FF"> 0</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="color:#BABED8;--shiki-dark:#79B8FF">            _</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit"> throw</span><span style="color:#89DDFF;--shiki-dark:#F97583"> new</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> UnreachableException</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">()</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">        &#125;;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#125;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>So a simple console application that spins the gears of our code will look like that:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">while</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> (</span><span style="color:#FF9CAC;--shiki-dark:#79B8FF">true</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#BABED8;--shiki-dark:#E1E4E8">    Console</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">Write</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">"</span><span style="color:#C3E88D;--shiki-dark:#9ECBFF">Write a property value: </span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">"</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#F97583">    var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> input</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> Console</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">ReadLine</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#F97583">    var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> value</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> Parse</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">input</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#BABED8;--shiki-dark:#E1E4E8">    Console</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">WriteLine</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">$"</span><span style="color:#C3E88D;--shiki-dark:#9ECBFF">Value '</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">&#123;</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">input</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">&#125;</span><span style="color:#C3E88D;--shiki-dark:#9ECBFF">' is valid: </span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">"</span><span style="color:#89DDFF;--shiki-dark:#F97583"> +</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> ValidationHelper</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">IsValid</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">value</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">));</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">    </span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">static</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IValue</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> Parse</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#F97583">string</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">?</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> value</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">    if</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> (</span><span style="color:#89DDFF;--shiki-dark:#F97583">long</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">TryParse</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">value</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">,</span><span style="color:#C792EA;--shiki-dark:#F97583"> out</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> num</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">))</span><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit"> return</span><span style="color:#89DDFF;--shiki-dark:#F97583"> new</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> NumericValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">num</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">    return</span><span style="color:#89DDFF;--shiki-dark:#F97583"> new</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> StringValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">value</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>Let’s test it:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span>Write a property value: foo</span></span>
<span class="line"><span>Value 'foo' is valid: True</span></span>
<span class="line"><span>Write a property value: 1 </span></span>
<span class="line"><span>Value '1' is valid: True</span></span>
<span class="line"><span>Write a property value: -42</span></span>
<span class="line"><span>Value '-42' is valid: False</span></span></code></pre><!----> <h2 id="the-issue"><a class="header-anchor" aria-hidden="true" tabindex="-1" href="#the-issue">#</a>The issue</h2> <p>At first glance everything looks fine! But what if we have dozens of such type pattern matching across the project, and some other developer introduces a new type for a value, for example, <code>DateTimeValue</code>?</p> <p>In that case, he or she needs to find all usages of pattern matching for <code>IValue</code> and add a branch for the new type. And also write tests to check that we won’t have an <code>UnreachableException</code> thrown at runtime:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> record</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> DateTimeValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">DateTimeOffset</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Value</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> :</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span></code></pre><!----> <p>As our case is very simple, still, let’s imaging that our imaginary developer implemented only parsing of the new type, but forgot to handle it in our helper function.</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">static</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IValue</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> Parse</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#F97583">string</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">?</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> value</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">    if</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> (</span><span style="color:#89DDFF;--shiki-dark:#F97583">long</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">TryParse</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">value</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">,</span><span style="color:#C792EA;--shiki-dark:#F97583"> out</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> num</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">))</span><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit"> return</span><span style="color:#89DDFF;--shiki-dark:#F97583"> new</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> NumericValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">num</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit">    // Parsing date, no other changes!</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">    if</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> (</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">DateTimeOffset</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">TryParse</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">value</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">,</span><span style="color:#C792EA;--shiki-dark:#F97583"> out</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> dateTime</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">))</span><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit"> return</span><span style="color:#89DDFF;--shiki-dark:#F97583"> new</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> DateTimeValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">dateTime</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">    return</span><span style="color:#89DDFF;--shiki-dark:#F97583"> new</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> StringValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">value</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>So, you may already guess what will happen if we pass <code>2024-02-18T19:38:37Z</code> to our CLI input.</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span>Write a property value: 2024-02-18T19:38:37Z</span></span>
<span class="line"><span>Unhandled exception. System.Diagnostics.UnreachableException: The program executed an instruction that was thought to be unreachable.                                </span></span>
<span class="line"><span>   at TypePatternMatchingOnVisitors.ValidationHelper.IsValid(IValue value) in C:UsersAxelUprojectslearnTypePatternMatchingOnVisitorsValidationHelper.cs:line 13</span></span>
<span class="line"><span>   at Program.&#x3C;Main>$(String[] args) in C:UsersAxelUprojectslearnTypePatternMatchingOnVisitorsProgram.cs:line 8                                                </span></span>
<span class="line"><span></span></span>
<span class="line"><span>Process finished with exit code -532,462,766.</span></span></code></pre><!----> <p>We found a bug! (how surprisingly, ha-ha)</p> <p>Imaging that this will happen in production during the midnight while you’re on-call. <strong>Not so funny now, huh?</strong></p> <h2 id="solution-visitor-pattern"><a class="header-anchor" aria-hidden="true" tabindex="-1" href="#solution-visitor-pattern">#</a>Solution: Visitor Pattern</h2> <p>I’m sure that this bug can be found with tests or during code-review. But can we have a compilation error, indicating what places to fix? Like in Kotlin or Java with sealed interfaces and classes that allow creating an exhaustive <code>when</code> expression without a default branch and receiving compilation errors when a new type is not handled.</p> <p>Unfortunately, in C# we don’t have language support for that yet. But surprisingly, an old-fashioned OOP pattern called <a href="https://refactoring.guru/design-patterns/visitor" rel="nofollow">Visitor</a> can help us achieve that. We can add a generic <code>Accept&lt;T></code> method for <code>IValue</code>, which accepts <code>IValueVisitor&lt;T></code> and returns a value of type <code>T</code>.</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> interface</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IValue</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#B392F0">    T</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> Accept</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">>(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">IValueVisitor</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> visitor</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>Interface <code>IValueVisitor&lt;T></code> has methods <code>Accept</code>, with overloads, each accepting an implementation of <code>IValue</code> interface as a parameter and returning a value of generic type <code>T</code>.</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> interface</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IValueVisitor</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#C792EA;--shiki-dark:#F97583">out</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#B392F0">    T</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> Visit</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">StringValue</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> stringValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#B392F0">    T</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> Visit</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">NumericValue</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> numericValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>In all <code>IValue</code> implementations, we just call <code>visitor.Visit(this)</code> and return the value from this invocation:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> record</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> StringValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#F97583">string</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">?</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Value</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">):</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IValue</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    public</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> T</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> Accept</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">>(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">IValueVisitor</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> visitor</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> visitor</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">Visit</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#79B8FF">this</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit">// ... same for other IValue implementations</span></span></code></pre><!----> <p>We can rewrite a helper validation function to a class <code>ValueValidationVisitor</code>, that for each <code>Visit</code> overload performs the same check as it was done for the static function described above, generic type parameter in that case will be <code>bool</code>. Here’s how it looks like:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> ValueValidationVisitor</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">:</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IValueVisitor</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#89DDFF;--shiki-dark:#F97583">bool</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    public</span><span style="color:#89DDFF;--shiki-dark:#F97583"> bool</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> Visit</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">StringValue</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> stringValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span><span style="color:#89DDFF;--shiki-dark:#F97583"> !</span><span style="color:#89DDFF;--shiki-dark:#F97583">string</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">IsNullOrWhiteSpace</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">stringValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">Value</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    public</span><span style="color:#89DDFF;--shiki-dark:#F97583"> bool</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> Visit</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">NumericValue</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> numericValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> numericValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">Value </span><span style="color:#89DDFF;--shiki-dark:#F97583">>=</span><span style="color:#F78C6C;--shiki-dark:#79B8FF"> 0</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>When a developer adds a new class implementing <code>IValue</code>, for example, <code>DateTimeValue</code>, we need to implement an <code>Accept</code> method, which should invoke the visitor’s <code>Visit</code> method:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> record</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> DateTimeValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">DateTimeOffset</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Value</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> :</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IValue</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit">    // Compilation error - we don't implement Visit for this value type yet!</span></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    public</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> T</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> Accept</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">>(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">IValueVisitor</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> visitor</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> visitor</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">Visit</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#79B8FF">this</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>But there’s no such overload at <code>IValueVisitor&lt;T></code> that accepts <code>DateTimeValue</code> value, so we’ve got to add it into <code>IValueVisitor&lt;T></code> and implement it all over visitor’s implementations:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> interface</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IValueVisitor</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#C792EA;--shiki-dark:#F97583">out</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit">    // ... other Visit overloads</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#B392F0">    T</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> Visit</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">DateTimeValue</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> dateTimeValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> ValueValidationVisitor</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">:</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IValueVisitor</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#89DDFF;--shiki-dark:#F97583">bool</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit">    // singleton for visitor cause it's stateless and safe to share between IValue instances</span></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    public</span><span style="color:#C792EA;--shiki-dark:#F97583"> static</span><span style="color:#C792EA;--shiki-dark:#F97583"> readonly</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> ValueValidationVisitor</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Instance</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =</span><span style="color:#89DDFF;--shiki-dark:#F97583"> new</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit">    // ... other Visit overloads</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    public</span><span style="color:#89DDFF;--shiki-dark:#F97583"> bool</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> Visit</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">DateTimeValue</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> dateTimeValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> dateTimeValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">Value </span><span style="color:#89DDFF;--shiki-dark:#F97583">&#x3C;=</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> DateTimeOffset</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">UtcNow</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span>
<span class="line"></span></code></pre><!----> <p>So after all tons of code we’ve written, we can now change the console app and use <code>ValueValidationVisitor</code> instead of <code>ValidationHelper</code>. There’s also a singleton instance of <code>ValueValidationVisitor</code> that we can use in client code, so let’s do it.</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">while</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> (</span><span style="color:#FF9CAC;--shiki-dark:#79B8FF">true</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#BABED8;--shiki-dark:#E1E4E8">    Console</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">Write</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">"</span><span style="color:#C3E88D;--shiki-dark:#9ECBFF">Write a property value: </span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">"</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#F97583">    var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> input</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> Console</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">ReadLine</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#F97583">    var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> value</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> Parse</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">input</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit">    //Console.WriteLine($"Value '&#123;input&#125;' is valid: " + ValidationHelper.IsValid(value));    </span></span>
<span class="line"><span style="color:#BABED8;--shiki-dark:#E1E4E8">    Console</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">WriteLine</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">$"</span><span style="color:#C3E88D;--shiki-dark:#9ECBFF">Value '</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">&#123;</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">input</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">&#125;</span><span style="color:#C3E88D;--shiki-dark:#9ECBFF">' is valid: </span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">"</span><span style="color:#89DDFF;--shiki-dark:#F97583"> +</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> value</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">Accept</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">ValueValidationVisitor</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">Instance</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">));</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">    </span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>Voilà, now not only the bug is fixed, but also the chance of missed type handling is reduced, so in overall we strengthen our type-safety guarantees.</p> <h2 id="final-thoughts"><a class="header-anchor" aria-hidden="true" tabindex="-1" href="#final-thoughts">#</a>Final thoughts</h2> <p>However Visitor pattern is a lot more verbose than simple switch statement or expression, we are now almost absolutely sure that the developer doesn’t miss to handle its new type. And as a reviewer, one will see all places that were changed in git diff without the need to double-check in the code of the project.</p> <p>So there you have it! By using Visitor pattern, you can make your C# code more maintainable and less prone to runtime errors, especially when adding new types or modifying existing ones. It may not be as elegant or concise, but it can save you a lot of headaches in the long run. If you want to see code - check it in <a href="https://github.com/AxelUser/TypePatternMatchingOnVisitors" rel="nofollow">this</a> repository.</p> <p>And remember, a little bit of extra verbosity is worth the peace of mind!</p><!----></div> <footer class="post-footer svelte-yczkrf"><div class="post-navigation svelte-yczkrf"><!--[--><a href="/blog" class="button primary medium svelte-1edpa7d"><!---->← Back to all posts<!----></a><!--]--><!----></div> <!--[!--><!--]--> <div class="card default svelte-1bwdm5p"><div class="share-message svelte-yczkrf">Enjoyed this post? Share it with the universe!</div> <div class="share-buttons svelte-yczkrf"><a class="link default share-link twitter svelte-blzdii" target="_blank" rel="noopener noreferrer" href="https://twitter.com/intent/tweet?text=Fixing%20C%23%20type%20pattern-matching&amp;url=" aria-label="Share on Twitter"><!---->Twitter<!----> <!--[!--><!--]--></a><!----> <a class="link default share-link linkedin svelte-blzdii" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/shareArticle?mini=true&amp;title=Fixing%20C%23%20type%20pattern-matching&amp;url=" aria-label="Share on LinkedIn"><!---->LinkedIn<!----> <!--[!--><!--]--></a><!----> <a class="link default share-link facebook svelte-blzdii" target="_blank" rel="noopener noreferrer" href="https://www.facebook.com/sharer/sharer.php?u=" aria-label="Share on Facebook"><!---->Facebook<!----> <!--[!--><!--]--></a><!----></div><!----> <!--[!--><!--]--></div><!----></footer></article><!----><!----></div></main> <footer class="svelte-1mbgpkc"><div class="space-container"><p class="space-text-small">© 2025 | Aleksey Maltsev</p></div></footer><!----></div><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_t06p97 = {
						base: new URL("..", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.By1qBRDJ.js"),
						import("../_app/immutable/entry/app.GFsoqh4X.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 7],
							data: [null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
