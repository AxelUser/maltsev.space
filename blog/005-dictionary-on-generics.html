<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1, maximum-scale=5, viewport-fit=cover"
		/>

		<!-- Favicons -->
		<link rel="icon" type="image/png" href="../favicon-96x96.png" sizes="96x96" />
		<link rel="icon" type="image/svg+xml" href="../favicon.svg" />
		<link rel="shortcut icon" href="../favicon.ico" />
		<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png" />
		<meta name="apple-mobile-web-app-title" content="Maltsev.Space" />
		<link rel="manifest" href="../site.webmanifest" />
		
		<link href="../_app/immutable/assets/one-column-layout.dk0RUYX7.css" rel="stylesheet">
		<link href="../_app/immutable/assets/tag-cloud.70LkpYqV.css" rel="stylesheet">
		<link href="../_app/immutable/assets/0.CaXpniMl.css" rel="stylesheet">
		<link href="../_app/immutable/assets/posts.BYtmJbQG.css" rel="stylesheet">
		<link href="../_app/immutable/assets/8.BFZU1Dea.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.Bd13R3TE.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BHHbfmq3.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/sVw9Ped7.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DS0R9CKb.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CYgJF_JY.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.Bi55SSnt.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Dp1pzeXC.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CqZlLleP.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/COfChAPb.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BUJIhQsn.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.D88qu2C5.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C04FsZVz.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/E2_GMQvN.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CPVJZChB.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DasYoi_Y.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/8.Bd5ggBuO.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DbeoEI5c.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Cq_8lF6v.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/J-DOm9KT.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DNSHY1Ls.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DtIdhLIQ.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/B67hBybd.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BLvE5VWU.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/CjY4LRRC.js"><!--[--><link rel="alternate" type="application/rss+xml" title="Aleksey Maltsev's Blog" href="/rss.xml"> <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"><!--]--><!--[--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css" integrity="sha384-5TcZemv2l/9On385z///+d7MSYlvIEw9FuZTIdZ14vJLqWphw7e7ZPuOiCHJcFCP" crossorigin="anonymous"><!--]--><!--[--><meta name="description" content="Do you want to improve performance of caching? Get rid of Dictionary and use just CLR for that!"> <link rel="canonical" href="https://maltsev.space/blog/005-dictionary-on-generics"> <!--[!--><meta name="robots" content="index, follow"><!--]--> <meta property="og:type" content="article"> <meta property="og:title" content="Unlocking the Power of Generics: Simulating Dictionary Behavior in C# | MALTSEV.SPACE"> <meta property="og:description" content="Do you want to improve performance of caching? Get rid of Dictionary and use just CLR for that!"> <meta property="og:image" content="https://maltsev.space/images/og/005-dictionary-on-generics.jpg"> <meta property="og:image:alt" content="Unlocking the Power of Generics: Simulating Dictionary Behavior in C# - Unlocking the Power of Generics: Simulating Dictionary Behavior in C#"> <meta property="og:url" content="https://maltsev.space/blog/005-dictionary-on-generics"> <meta property="og:site_name" content="MALTSEV.SPACE"> <meta property="og:locale" content="en_US"> <!--[--><!--[--><meta property="article:published_time" content="2020-06-22T00:00:00.000Z"><!--]--> <!--[!--><!--]--> <!--[--><meta property="article:author" content="Aleksey Maltsev"><!--]--> <meta property="article:section" content="Technology"> <!--[--><meta property="article:tag" content="C#"><meta property="article:tag" content="generics"><meta property="article:tag" content="C#"><!--]--><!--]--> <meta name="twitter:card" content="summary_large_image"> <meta name="twitter:title" content="Unlocking the Power of Generics: Simulating Dictionary Behavior in C# | MALTSEV.SPACE"> <meta name="twitter:description" content="Do you want to improve performance of caching? Get rid of Dictionary and use just CLR for that!"> <meta name="twitter:image" content="https://maltsev.space/images/og/005-dictionary-on-generics.jpg"> <meta name="twitter:image:alt" content="Unlocking the Power of Generics: Simulating Dictionary Behavior in C# - Unlocking the Power of Generics: Simulating Dictionary Behavior in C#"> <meta name="twitter:site" content="@axel_user"> <meta name="twitter:creator" content="@axel_user">  <!----><script type="application/ld+json">{"@context":"https://schema.org","@type":"Person","name":"Aleksey Maltsev","jobTitle":"Senior Software Engineer","description":"Senior Software Engineer focused on distributed systems and highload applications","url":"https://maltsev.space/","image":"https://maltsev.space/images/ava.jpg","sameAs":["https://github.com/AxelUser","https://www.linkedin.com/in/dev-alexey-maltsev/"]}</script><!----> <!--[!--><!--]--> <!--[--><!----><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"Unlocking the Power of Generics: Simulating Dictionary Behavior in C#","description":"Do you want to improve performance of caching? Get rid of Dictionary and use just CLR for that!","image":"https://maltsev.space/images/og/005-dictionary-on-generics.jpg","author":{"@context":"https://schema.org","@type":"Person","name":"Aleksey Maltsev","jobTitle":"Senior Software Engineer","description":"Senior Software Engineer focused on distributed systems and highload applications","url":"https://maltsev.space/","image":"https://maltsev.space/images/ava.jpg","sameAs":["https://github.com/AxelUser","https://www.linkedin.com/in/dev-alexey-maltsev/"]},"publisher":{"@context":"https://schema.org","@type":"Person","name":"Aleksey Maltsev","jobTitle":"Senior Software Engineer","description":"Senior Software Engineer focused on distributed systems and highload applications","url":"https://maltsev.space/","image":"https://maltsev.space/images/ava.jpg","sameAs":["https://github.com/AxelUser","https://www.linkedin.com/in/dev-alexey-maltsev/"]},"url":"https://maltsev.space/blog/005-dictionary-on-generics","datePublished":"2020-06-22T00:00:00.000Z","dateModified":"2020-06-22T00:00:00.000Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://maltsev.space/blog/005-dictionary-on-generics"},"keywords":["C#","generics","C#"]}</script><!----><!--]--><!--]--><title>Unlocking the Power of Generics: Simulating Dictionary Behavior in C# | MALTSEV.SPACE</title>
	</head>

	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><div class="space-layout svelte-144yekp"><header class="svelte-1eq0cli"><div class="space-container nav-bar svelte-7gsxae"><div class="logo svelte-1eq0cli"><a href="/" class="svelte-1eq0cli">MALTSEV.SPACE</a></div> <ul class="nav-links svelte-1eq0cli"><li><a class="nav-link svelte-1eq0cli" href="/">Home</a></li> <li><a class="nav-link svelte-1eq0cli" href="/about">About</a></li> <li><a class="nav-link svelte-1eq0cli" href="/art">Gallery</a></li> <li><a class="nav-link svelte-1eq0cli" href="/blog">Blog</a></li></ul> <div class="nav-actions svelte-1eq0cli"><a href="/rss.xml" class="rss-link nav-link svelte-1eq0cli" aria-label="RSS Feed"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide-icon lucide lucide-rss"><!--[--><!----><path d="M4 11a9 9 0 0 1 9 9"><!----></path><!----><!----><path d="M4 4a16 16 0 0 1 16 16"><!----></path><!----><!----><circle cx="5" cy="19" r="1"><!----></circle><!----><!--]--><!----><!----></svg><!----></a> <div class="theme-switch svelte-awph5w"><button class="theme-button svelte-awph5w" title="Light theme" aria-label="Light theme"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-icon lucide lucide-sun"><!--[--><!----><circle cx="12" cy="12" r="4"><!----></circle><!----><!----><path d="M12 2v2"><!----></path><!----><!----><path d="M12 20v2"><!----></path><!----><!----><path d="m4.93 4.93 1.41 1.41"><!----></path><!----><!----><path d="m17.66 17.66 1.41 1.41"><!----></path><!----><!----><path d="M2 12h2"><!----></path><!----><!----><path d="M20 12h2"><!----></path><!----><!----><path d="m6.34 17.66-1.41 1.41"><!----></path><!----><!----><path d="m19.07 4.93-1.41 1.41"><!----></path><!----><!--]--><!----><!----></svg><!----></button> <button class="theme-button svelte-awph5w" title="Dark theme" aria-label="Dark theme"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-icon lucide lucide-moon"><!--[--><!----><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"><!----></path><!----><!--]--><!----><!----></svg><!----></button> <button class="theme-button svelte-awph5w active" title="System theme" aria-label="System theme"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide-icon lucide lucide-laptop"><!--[--><!----><path d="M20 16V7a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v9m16 0H4m16 0 1.28 2.55a1 1 0 0 1-.9 1.45H3.62a1 1 0 0 1-.9-1.45L4 16"><!----></path><!----><!--]--><!----><!----></svg><!----></button></div><!----> <button class="mobile-menu-toggle svelte-1eq0cli" aria-label="Toggle menu"><!--[!--><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="lucide-icon lucide lucide-menu"><!--[--><!----><path d="M4 12h16"><!----></path><!----><!----><path d="M4 18h16"><!----></path><!----><!----><path d="M4 6h16"><!----></path><!----><!--]--><!----><!----></svg><!--]--></button></div><!----></div><!----> <div class="mobile-nav svelte-1eq0cli"><ul class="svelte-1eq0cli"><li class="svelte-1eq0cli"><a class="nav-link svelte-1eq0cli" href="/">Home</a></li> <li class="svelte-1eq0cli"><a class="nav-link svelte-1eq0cli" href="/about">About</a></li> <li class="svelte-1eq0cli"><a class="nav-link svelte-1eq0cli" href="/art">Gallery</a></li> <li class="svelte-1eq0cli"><a class="nav-link svelte-1eq0cli" href="/blog">Blog</a></li></ul></div></header><!----> <div class="stars-background svelte-1xnwqdy"><!--[--><!--]--></div><!----> <main class="svelte-144yekp"><!--[!--><!----><!----> <div class="hero-background-container svelte-18l6c9h"><!--[--><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAXCAYAAABqBU3hAAAMEElEQVR4AQCBAH7/AAAGBP8ABgT/AAcF/wAIBv8ACgj/Ag4M/wUSEP8KFhT/DRkX/w8bGf8QHBr/DxsZ/w0ZF/8LFxX/CRUT/wkVE/8KFxX/DhoY/xMfHf8YJCL/HCgm/x4qKP8fKyn/HSkn/xklI/8UIB7/DxsZ/wsXFf8HExH/BREP/wMPDf8DDw3/AIEAfv8AAAgG/wAIBv8ACAb/AAoI/wAMCv8DDw3/BxMR/wsXFf8OGhj/ER0b/xEdG/8QHBr/DhoY/wwYFv8KFhT/ChYU/wwYFv8PGxn/FCAe/xklI/8dKSf/Hysp/x8sKv8dKSf/GSYk/xUhH/8QHBr/CxcV/wgUEv8FEQ//BBAO/wMPDf8AgQB+/wAACgj/AAsJ/wALCf8ADAr/Ag4M/wUSEP8JFRP/DRkX/xEdG/8THx3/FCAe/xMfHf8RHRv/DxsZ/w0ZF/8NGRf/DhsZ/xIeHP8WIyH/Gycl/x8rKf8hLSv/IS0r/x8rKf8bJyX/FiIg/xEdG/8MGBb/CRUT/wYTEP8FEQ//BBEO/wCBAH7/AAIODP8CDw3/Aw8N/wQQDv8GEhD/CRUT/w0ZF/8RHRv/FCAe/xcjIf8XIyH/FiMh/xUhH/8SHx3/ER0b/xEdG/8SHx3/FiIg/xomJP8fKyn/Iy8t/yQxL/8kMC7/IS4s/x0pJ/8YJCL/Ex8d/w4bGP8LFxX/CRUT/wcTEf8HExH/AIEAfv8ABxQR/wcUEv8IFBL/CRUT/wsXFf8OGhj/ER4c/xUhH/8ZJSP/Gycl/xwoJv8bJyX/GSYk/xckIv8WIiD/FiIg/xgkIv8bJyX/Hysp/yQwLv8nMzH/KTUz/yg0Mv8lMS//IS0r/xsoJv8WIiD/Eh4c/w4aGP8MGBb/ChcV/woWFP8AgQB+/wANGRf/DRkX/w0aGP8OGxn/EBwa/xMfHf8XIyH/Gick/x4qKP8gLCr/IS0r/yAtK/8fKyn/HSkn/xwoJv8cKCb/Hioo/yEtK/8lMS//KTYz/y05N/8uOjj/LTk3/yo2NP8lMS//ICwq/xonJf8WIiD/Ex8d/xAcGv8PGxn/DxsZ/wCBAH7/ABMfHf8THx3/Ex8d/xQgHv8WIiD/GCUi/xwoJv8fLCr/Iy8t/yUxL/8mMjD/JjIw/yQxL/8jLy3/Ii4s/yIuLP8kMC7/JzMx/ys4Nv8vPDr/Mj89/zRAPv8yPzz/Lzs5/yo3NP8lMS//ICwq/xsnJf8YJCL/FiIg/xUhH/8UIB7/AIEAfv8AGCQi/xgkIv8YJSL/GSUj/xsnJf8dKSf/IS0r/yQwLv8nNDL/KjY0/ys3Nf8rNzX/KjY0/yg0Mv8nMzH/KDQy/yo2NP8tOTf/MT07/zVBP/84REL/OUVD/zhEQv80QT//MDw6/yo2NP8lMS//IS0r/x4qKP8cKCb/Gycl/xomJP8AgQB+/wAcKSf/HCgm/xwpJ/8dKSf/Hysp/yEtK/8kMC7/KDQy/ys3Nf8tOTf/Ljs5/y46OP8tOTf/LDg2/yw4Nv8sODb/Ljs5/zI+PP82QkD/OkZE/z1JR/8+Skj/PEhG/zlFQ/80QD7/Lzs5/yo2NP8mMjD/Iy8t/yEtK/8gLCr/ICwq/wCBAH7/AB8rKf8fKyn/Hysp/x8sKv8hLSv/Iy8t/yYyMP8qNjT/LTk3/y87Of8wPDr/MDw6/y87Of8uOjj/Ljo4/y87Of8xPTv/NUE//zlFQ/89SUf/QExK/0FNS/8/S0n/PEhG/zdDQf8yPjz/LTk3/yk1M/8nMzH/JTEv/yUxL/8kMS7/AIEAfv8AHywq/x8sKf8fLCn/ICwq/yEtK/8jLy3/JjIw/yk2NP8sOTf/Lzs5/zA8Ov8wPDr/Lzs5/y46OP8uOjj/Lzs5/zE9O/81QT//OUVD/z1JR/9ATEr/QU1L/0BMSv88SUf/OERC/zM/Pf8uOjj/Kzc1/yg1M/8nMzH/JzMx/yczMf8AgQB+/wAeKij/Hioo/x4qKP8eKij/Hywp/yEuLP8kMC7/JzMx/yo2NP8sODb/LTk3/y05N/8sODb/Kzc1/ys3Nf8sODb/Lzs5/zM/Pf83Q0H/O0dF/z5KSP8/S0n/PkpI/zpHRf82QkD/MT07/y05N/8qNjT/KDQy/yczMf8nMzH/JzMx/wCBAH7/ABsnJf8aJyX/Gick/xsnJf8cKCb/Hioo/yEtK/8jMC7/JjIw/yg0Mv8pNTP/KTUz/yg0Mv8nMzH/JjIw/yczMf8qNjT/Ljo4/zI+PP82Q0H/OUVD/zpGRP85RUP/NkJA/zI+PP8tOTf/KTUz/yYzMf8lMS//JDAu/yQwLv8kMC7/AIEAfv8AFiIg/xYiIP8WIiD/FiIg/xcjIf8ZJSP/HCgm/x4rKf8hLSv/Iy8t/yMvLf8jLy3/IS4r/yAsKv8gLCr/IS0r/yMwLv8nMzH/LDg2/zA8Ov8zPz3/NEA+/zM/Pf8wPDr/LDg2/yc0Mv8kMC7/IS0r/yAsKv8fKyn/Hysp/yAsKv8AgQB+/wAQHBr/EBwa/xAcGv8RHRv/Eh4c/xQgHv8WIiD/GSUj/xsnJf8dKSf/HSkn/xwoJv8bJyX/GSUj/xklI/8aJiT/HCgm/yAsKv8kMC7/KDUz/ys3Nf8sOTb/Kzc1/yk1M/8lMS//IC0r/x0pJ/8bJyX/GSUj/xklI/8ZJiP/GiYk/wCBAH7/AAsXFf8LFxX/CxcV/wwYFv8NGRf/DxsZ/xEdG/8UIB7/FiIg/xcjIf8XIyH/FiIg/xQgHv8THx3/Eh4c/xMfHf8VIR//GSUj/x0pJ/8hLSv/JDAu/yUxL/8kMC7/IS0r/x4qKP8aJiT/FiIg/xQgHv8THx3/Ex8d/xMfHf8UIB7/AIEAfv8ABhMQ/wYTEf8HExH/BxMR/wkVE/8LFxX/DRkX/xAcGv8SHhz/Ex8d/xIfHf8RHRv/DxsZ/w0ZF/8MGBb/DRkX/w8bGf8SHhz/FyMh/xsnJf8eKij/Hysp/x4qKP8bJyX/FyMh/xMgHv8QHBr/DhoY/w0ZF/8NGRf/DhoY/w4aGP8AgQB+/wADDw3/Aw8N/wMQDf8EEA7/BhIQ/wgUEv8KFxX/DRkX/w8bGf8QHBr/DxsZ/w4aGP8LFxX/CRUT/wgUEv8IFBL/ChYU/w4aGP8SHhz/FiIg/xklI/8aJiT/GSUj/xYjIf8THx3/DxsZ/wwYFv8KFhT/CRUT/wkVE/8KFhT/ChYU/wCBAH7/AAENC/8BDQv/AQ4M/wIPDf8EEA7/BhMR/wkVE/8MGBb/DhoY/w4bGP8OGhj/DBgW/wkWFP8HExH/BhIQ/wYSEP8IFBL/CxcV/w8bGf8THx3/FiIg/xcjIf8WIiD/FCAe/xAcGv8MGRf/CRUT/wcUEv8HExH/BxMR/wgUEv8IFBL/AIEAfv8AAAwK/wAMCv8BDQv/Ag4M/wQQDv8GEhD/CRUT/wwYFv8OGhj/DhoY/w4aGP8MGBb/CRUT/wYTEf8FEQ//BREP/wcTEf8KFhT/DhoY/xIeHP8VIR//FiIg/xUhH/8THx3/DxsZ/wsYFv8IFRP/BxMR/wYSEP8GEhD/BxMR/wcTEf8AgQB+/wAADAr/AAwK/wENC/8CDgz/BBAO/wcTEf8KFhT/DBkX/w4bGf8PGxn/DhoY/wwYFv8JFhT/BxMR/wURD/8FEQ//BxMR/woWFP8OGhj/Eh4c/xUhH/8WIiD/FSIg/xMfHf8PGxn/DBgW/wkVE/8HExH/BhIQ/wYTEf8HExH/CBQS/wCBAH7/AAAMCv8ADQv/AQ0L/wMPDf8FEQ//CBQS/wsXFf8NGhj/DxwZ/xAcGv8PGxn/DRkX/woWFP8IFBL/BhIQ/wYSEP8HFBL/CxcV/w8bGf8THx3/FiIg/xcjIf8WIiD/EyAe/xAcGv8MGBb/CRUT/wcUEv8HExH/BxMR/wgUEv8IFRP/AYEAfv8AAAwK/wENC/8CDgz/Aw8N/wURD/8IFBL/CxcV/w4aGP8QHBr/ER0b/xAcGv8OGhj/CxcV/wgUEv8GEhD/BhIQ/wgUEv8LFxX/DxsZ/xMfHf8WIiD/FyMh/xYjIf8UIB7/EB0b/w0ZF/8KFhT/CBQS/wcUEv8IFBL/CBUT/wkVE//t8/BIVKP1LAAAAABJRU5ErkJggg==" alt="Unlocking the Power of Generics: Simulating Dictionary Behavior in C# hero image placeholder" class="hero-image hero-placeholder-image svelte-18l6c9h"> <!--[!--><picture class="svelte-18l6c9h"><!--[--><source srcset="/_app/immutable/assets/hero.CMSvxqpR.avif 1x, /_app/immutable/assets/hero.DGqwDLV0.avif 2x" sizes="min(1536px, 100vw)" type="image/avif" class="svelte-18l6c9h"><source srcset="/_app/immutable/assets/hero.xbmgkTNi.webp 1x, /_app/immutable/assets/hero.krAISNQ_.webp 2x" sizes="min(1536px, 100vw)" type="image/webp" class="svelte-18l6c9h"><source srcset="/_app/immutable/assets/hero.Cnr-Y4I7.jpg 1x, /_app/immutable/assets/hero.COcOnB5N.jpg 2x" sizes="min(1536px, 100vw)" type="image/jpeg" class="svelte-18l6c9h"><!--]--> <img src="/_app/immutable/assets/hero.COcOnB5N.jpg" alt="Unlocking the Power of Generics: Simulating Dictionary Behavior in C# hero image" loading="lazy" class="hero-image hero-background-image svelte-18l6c9h" width="1536" height="1024" onload="this.__e=event" onerror="this.__e=event"></picture><!--]--><!--]--> <div class="hero-content svelte-18l6c9h"><hgroup class="svelte-18l6c9h"><div class="post-meta svelte-18l6c9h"><time datetime="2024-06-15" class="publish-date svelte-18l6c9h">2020-06-22</time> <span class="meta-separator svelte-18l6c9h">•</span> <span class="author-name svelte-18l6c9h">by Aleksey Maltsev</span> <!--[--><span class="meta-separator svelte-18l6c9h">•</span> <span class="views-count svelte-18l6c9h">29 views</span><!--]--></div> <h1 class="space-title svelte-18l6c9h">Unlocking the Power of Generics: Simulating Dictionary Behavior in C#</h1> <!--[--><p class="post-preview svelte-18l6c9h">Do you want to improve performance of caching? Get rid of Dictionary and use just CLR for that!</p><!--]--></hgroup></div></div><!----> <div class="space-container undefined svelte-7gsxae"><article class="svelte-1dc6gs2"><div class="post-navigation top-navigation svelte-1dc6gs2"><!--[--><a href="/blog" class="button primary medium svelte-1edpa7d"><!---->← Back to all posts<!----></a><!--]--><!----></div> <!--[!--><!--]--> <div class="prose"><h2 id="disclaimer"><a class="header-anchor" aria-hidden="true" tabindex="-1" href="#disclaimer">#</a>Disclaimer</h2> <ol><li>This article shows how to simulate dictionary behavior with generic static classes. However, <strong>the way to this solution goes through other examples with lots of design details</strong> to make you familiar with the situation. If you’re interested only in “hacking” part, you may go directly to the section <a href="#implementing-a-generic-based-cached-producer">Implementing a generic-based cached producer</a>.</li> <li>In code examples I’ve used <strong>Nullable Reference Types</strong>, which is a new feature from <strong>C# 8</strong>. They don’t affect the performance and definitely not a main point of the article. If you’re curious, check the <a href="https://docs.microsoft.com/en-us/dotnet/csharp/nullable-references" rel="nofollow">documentation</a>.</li> <li>All code is available on <a href="https://github.com/AxelUser/examples/tree/master/DotNet/DictionaryOfTypes" rel="nofollow">GitHub</a>.</li></ol> <h2 id="task-create-a-factory-for-rest-clients"><a class="header-anchor" aria-hidden="true" tabindex="-1" href="#task-create-a-factory-for-rest-clients">#</a>Task: Create a Factory for REST Clients</h2> <p>When you are integrating different services into each other, it’s always a very time-consuming process to write clients for all of them. Luckily, if those RESTful services provide their API schema in <strong>OpenAPI</strong> (or previously named <strong>Swagger</strong>) format, chances are great that there’s a generator of clients for this common type of schema format.</p> <p>.Net has several packages for client generation, for example <a href="https://github.com/RicoSuter/NSwag" rel="nofollow">NSwag</a>. There are different opinions on how generated clients should be look like, but let’s consider that their constructors receive <em>HttpClient</em> instance for sending requests and classes themselves are derived from generated interfaces, containing all public methods for the API.</p> <p>The first requirement helps to manipulate <em>HttpClient</em> creation and lifetime, which means that we can even reuse one from the pool. The second requirement will be handy, when it’s needed to write unit-tests for code, that uses service’s clients - in that case they must be mocked and mocking in .Net’s frameworks “mostly” requires passing an interface.</p> <p>To sum everything up, the generated code will follow the similar pattern:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#C792EA;--shiki-dark:#F97583"> partial</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> interface</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> ISomeResourceClient</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#B392F0">	Task</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">SwaggerResponse</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#89DDFF;--shiki-dark:#F97583">string</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">>></span><span style="color:#82AAFF;--shiki-dark:#B392F0"> GetSomeResourceAsync</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">CancellationToken</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> cancellationToken</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#C792EA;--shiki-dark:#F97583"> partial</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> SomeResourceClient</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> :</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> ISomeResourceClient</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">	private</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> HttpClient</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> _httpClient</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">	public</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> SystemClient</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">HttpClient</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> httpClient</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">	&#123;</span></span>
<span class="line"><span style="color:#BABED8;--shiki-dark:#E1E4E8">		_httpClient </span><span style="color:#89DDFF;--shiki-dark:#F97583">=</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> httpClient</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">	&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">	public</span><span style="color:#C792EA;--shiki-dark:#F97583"> async</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Task</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">SwaggerResponse</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#89DDFF;--shiki-dark:#F97583">string</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">>></span><span style="color:#82AAFF;--shiki-dark:#B392F0"> GetUpdaterLinkAsync</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">CancellationToken</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> cancellationToken</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">	&#123;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit">		// Generated code for sending request.</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">	&#125;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <h2 id="automating-client-creation"><a class="header-anchor" aria-hidden="true" tabindex="-1" href="#automating-client-creation">#</a>Automating Client Creation</h2> <p>Although clients are implementing their own interfaces, it’s still hard to test code, that creates clients via constructors. For a testable code it’s required to have all those clients as dependencies or delegate their creation into a new dependency. It’s possible to resolve clients via <strong>Dependency Injection</strong>, because <em>HttpClient</em> can be effectively taken from reusable pool via <a href="https://docs.microsoft.com/en-us/dotnet/architecture/microservices/implement-resilient-applications/use-httpclientfactory-to-implement-resilient-http-requests" rel="nofollow">IHttpClientFactory</a>, and most of the DI frameworks offer you a zero configuration for that feature.</p> <p>However sometimes it’s necessary to control base url to your service or to dynamically pass some values into request’s headers, like authorization tokens or distributed tracing ids. So it may be preferred to pass a valid <em>HttpClient</em> manually and that’s why for the sake of the article let’s stick to this format.</p> <p>The most appropriate way of extracting object construction into dedicated dependency is implementing a <a href="https://refactoring.guru/design-patterns/factory-method" rel="nofollow">Factory</a> for clients. Unfortunately, all clients implement different interfaces and it isn’t possible to write base interface as returned value for the factory method. However it’s still possible to invoke the creation of specific client by redesigning the factory into generic class.</p> <p>Let’s discuss possible interface:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> interface</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#C792EA;--shiki-dark:#F97583">out</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span><span style="color:#C792EA;--shiki-dark:#F97583"> where</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">:</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#B392F0">    T</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> Create</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">HttpClient</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> client</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>Why it’s preferred to make whole class as generic and not just the method <code>Create</code>? If it will be only a generic method, the factory will be similar to the <a href="https://blog.ploeh.dk/2010/02/03/ServiceLocatorisanAnti-Pattern/" rel="nofollow">Service Locator</a>, which has some maintainability issues and hides the information which clients the outer code depends on.</p> <p>Here is an example:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> Wrapper</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="color:#BABED8;--shiki-dark:#E1E4E8">    IClientFactory</span><span style="color:#89DDFF;--shiki-dark:#F97583">&#x3C;</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">ISomeResourceClient</span><span style="color:#89DDFF;--shiki-dark:#F97583">></span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> concreteClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">,</span><span style="color:#676E95;font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit"> // doesn't hide details</span></span>
<span class="line"><span style="color:#BABED8;--shiki-dark:#E1E4E8">    IClientFactory commonClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit">    // some ctor details</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>The first variant of <code>concreteClientFactory</code> is much more transparent than <code>commonClientFactory</code>. <strong>That’s why this design will be applied to all further solutions it the article.</strong></p> <p>As factory should create clients of specific types, there are some more questions to discuss:</p> <ol><li>How factory should invoke a constructor of the concrete client?</li> <li>How factory should effectively guess object of which class should be created, if only interface is passed to the generic type parameter?</li></ol> <p>Solution for the first question is quite trivial - invoking constructor via handy static helper <a href="https://docs.microsoft.com/en-gb/dotnet/api/system.activator.createinstance?view=netcore-3.1#System_Activator_CreateInstance_System_Type_System_Object___" rel="nofollow">Activator.CreateInstance</a>. Internally it’s an old friend reflection does all the job, but activator provides a simpler API.</p> <p>For the second problem another reflection-based mechanism should be involved. As I mentioned above, mocking frameworks for .Net work better, if they create mocks that implement base interfaces. Thus the factory method should expose client’s interface in returned value. It can be easily achieved with the help of generic type parameter, but nevertheless factory method should create an object of the concrete class.</p> <p>So, factory should perform mapping between the interface and the implementation. Fortunately, all generated classes and interfaces are stored under dedicated namespace and are available during the start of an application. That’s right - <strong>mapping can be created by traversing though all classes in that namespace</strong>.</p> <p>To execute search only once, it’s better to put mapping code into a <strong>static constructor</strong>. Reflection will traverse through the whole assembly, find all client’s interfaces with their implementations and save that relationships into a simple dictionary. Also it’a a good idea to <strong>encapsulate mapping into another dependency</strong>, which has private static field with that dictionary and produces the factory for required clients. Encapsulation will protect internal mapping from unexpected mutations and make namespace cleaner.</p> <p>The new dependency can be implemented as a factory provider, or in other words factory of factories. The interface is trivial:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> interface</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IClientsFactoryProvider</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#B392F0">    IClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span><span style="color:#82AAFF;--shiki-dark:#B392F0"> GetClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">>()</span><span style="color:#C792EA;--shiki-dark:#F97583"> where</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> :</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>Type of the client’s implementation can be passed into client factory constructor by factory provider. Thus, after factory provider is invoked, it finds relevant class for an interface passed as generic type argument and creates the valid client factory. Below is the implementation of the provider:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> SimpleClientFactoryProvider</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">:</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IClientsFactoryProvider</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    private</span><span style="color:#C792EA;--shiki-dark:#F97583"> static</span><span style="color:#C792EA;--shiki-dark:#F97583"> readonly</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Dictionary</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">Type</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">,</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Type</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> DiscoveredAllowedClientTypes</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    static</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> SimpleClientFactoryProvider</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">()</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#123;</span></span>
<span class="line"><span style="color:#BABED8;--shiki-dark:#E1E4E8">        DiscoveredAllowedClientTypes </span><span style="color:#89DDFF;--shiki-dark:#F97583">=</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> GetAllTypes</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">Assembly</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">GetExecutingAssembly</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">())</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">            .</span><span style="color:#82AAFF;--shiki-dark:#B392F0">ToDictionary</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">tuple</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> tuple</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">@interface</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">,</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> tuple</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> tuple</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">implementation</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    public</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span><span style="color:#82AAFF;--shiki-dark:#B392F0"> GetClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">>()</span><span style="color:#C792EA;--shiki-dark:#F97583"> where</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> :</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#123;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">        if</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#F97583">!</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">DiscoveredAllowedClientTypes</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">TryGetValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#F97583">typeof</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">),</span><span style="color:#C792EA;--shiki-dark:#F97583"> out</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> implType</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">))</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">            throw</span><span style="color:#89DDFF;--shiki-dark:#F97583"> new</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Exception</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">$"</span><span style="color:#C3E88D;--shiki-dark:#9ECBFF">Client type '</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">&#123;</span><span style="color:#89DDFF;--shiki-dark:#F97583">typeof</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">)&#125;</span><span style="color:#C3E88D;--shiki-dark:#9ECBFF">' isn't supported</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">"</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">        return</span><span style="color:#89DDFF;--shiki-dark:#F97583"> new</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> ClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">>(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">implType</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    private</span><span style="color:#C792EA;--shiki-dark:#F97583"> static</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IEnumerable</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">Type</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> @interface</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">,</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Type</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> implementation</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)></span><span style="color:#82AAFF;--shiki-dark:#B392F0"> GetAllTypes</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">Assembly</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> assembly</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#123;</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#F97583">        var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> clientsTypes</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> assembly</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">DefinedTypes</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">            .</span><span style="color:#82AAFF;--shiki-dark:#B392F0">Where</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">type</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> type</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">CustomAttributes</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">                .</span><span style="color:#82AAFF;--shiki-dark:#B392F0">Any</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">attr</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> attr</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">AttributeType </span><span style="color:#89DDFF;--shiki-dark:#F97583">==</span><span style="color:#89DDFF;--shiki-dark:#F97583"> typeof</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">RestClientAttribute</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">        foreach</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> (</span><span style="color:#FFCB6B;--shiki-dark:#F97583">var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> clientType</span><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit"> in</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> clientsTypes</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">        &#123;</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#F97583">            var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> @interface</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> clientType</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">ImplementedInterfaces</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">First</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">            yield</span><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit"> return</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> (</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">@interface</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">,</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> clientType</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">        &#125;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#125;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>Everything is done so far. All mapping is extracted into provider, which had permitted the easier implementation of the actual client factory:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> ClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">>:</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span><span style="color:#C792EA;--shiki-dark:#F97583"> where</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> :</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    private</span><span style="color:#C792EA;--shiki-dark:#F97583"> readonly</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Type</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> _clientImplType</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    public</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> ClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">Type</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> clientImplType</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#123;</span></span>
<span class="line"><span style="color:#BABED8;--shiki-dark:#E1E4E8">        _clientImplType </span><span style="color:#89DDFF;--shiki-dark:#F97583">=</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> clientImplType</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    public</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> T</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> Create</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">HttpClient</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> client</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#123;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">        return</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> (</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> Activator</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">CreateInstance</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">_clientImplType</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">,</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> client</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span><span style="color:#89DDFF;--shiki-dark:#F97583">!</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#125;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>Now it’s time to ask, <strong>what can be done to produce factories more efficiently</strong>. If factory creation will be done very often, it’s better to make some kind of caching for it, because it doesn’t depend on a context of invocation.</p> <p>I want to mention, that all modern DI frameworks has an ability to mark those client factories as singletons at configuration and that’s OK to use it when you can.</p> <p>Even so, what about making this mechanism by ourselves? If you’re interested, I’ll welcome you to read the article further.</p> <h2 id="benchmarking"><a class="header-anchor" aria-hidden="true" tabindex="-1" href="#benchmarking">#</a>Benchmarking</h2> <p>Before we dig into optimizations, <strong>it’s HIGHLY recommended to track the performance of made solutions</strong>. As we are dealing with isolated modules, micro-benchmarking will suit our needs.</p> <p>The easiest way to create benchmarks of that kind is using a popular nuget package <a href="https://benchmarkdotnet.org/" rel="nofollow">BenchmarkDotNet</a>. I won’t include in the article how to write good benchmarks for every situation, because this theme is quite vast. However, if you’re not familiar with benchmarking or BenchmarkDotNet, you may follow the links to BenchmarkDotNet documentation at the section <strong>References</strong>.</p> <p>Frankly speaking, I shall mention that maintainers of the BenchmarkDotNet did a great job in providing an easy API for creating benchmarks, which gives ability to include lots of useful indicators and will be clear to the most of .Net developers.</p> <p>Firstly we need to know how solutions are fast and how much memory they consume. In BenchmarkDotNet speed indicator come out of the box, and memory consumption can be tracked via <a href="https://adamsitnik.com/the-new-Memory-Diagnoser/" rel="nofollow"><code>MemoryDiagnoser</code></a> attribute for the benchmark class. Here is a code snippet of configuration:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">[</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">MemoryDiagnoser</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> ClientFactoryProvidersBenchmark</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit">	// Benchmarks</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>Now it’s time for benchmarks themselves. <strong>Caching improves peeking of some value many times</strong>, that’s why benchmark should also perform several attempts of getting factories for each client.</p> <p>To show how many attempts were performed, BenchmarkDotNet has an ability to use custom benchmark parameters via another attribute <a href="https://benchmarkdotnet.org/articles/features/parameterization.html" rel="nofollow"><code>Params</code></a>. It receives values of that parameter for each benchmark run and displays that value at its own column in report. For this benchmark let’s choose numbers <em>100</em>, <em>1000</em> and <em>10000000</em>:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">[</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">Params</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#F78C6C;--shiki-dark:#79B8FF">100</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">,</span><span style="color:#F78C6C;--shiki-dark:#79B8FF"> 1000</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">,</span><span style="color:#F78C6C;--shiki-dark:#79B8FF"> 10000000</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#89DDFF;--shiki-dark:#F97583"> int</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> Accesses </span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> get</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> set</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> &#125;</span></span></code></pre><!----> <p>Another useful feature is making benchmark for original solution as <a href="https://benchmarkdotnet.org/articles/features/baselines.html" rel="nofollow">baseline</a>. It is used to display the ratio of how speed of other benchmarks differs from the baseline.</p> <p>Alright, now everything is ready to write the code of the first benchmark:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">[</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">Benchmark</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">Baseline</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =</span><span style="color:#FF9CAC;--shiki-dark:#79B8FF"> true</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#89DDFF;--shiki-dark:#F97583"> void</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> SimpleFactory_SequentialAccess</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">()</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#82AAFF;--shiki-dark:#B392F0">    Execute</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">_simpleFactoryRunActions</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">[</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">MethodImpl</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">MethodImplOptions</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">AggressiveInlining</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)]</span></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">private</span><span style="color:#89DDFF;--shiki-dark:#F97583"> void</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> Execute</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">IReadOnlyList</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">Action</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> actions</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#F97583">    var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> length</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> actions</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">Count</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">    for</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> (</span><span style="color:#FFCB6B;--shiki-dark:#F97583">var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> i</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =</span><span style="color:#F78C6C;--shiki-dark:#79B8FF"> 0</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> i </span><span style="color:#89DDFF;--shiki-dark:#F97583">&#x3C;</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> Accesses</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> i</span><span style="color:#89DDFF;--shiki-dark:#F97583">++</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#123;</span></span>
<span class="line"><span style="color:#BABED8;--shiki-dark:#E1E4E8">        actions</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">[</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">i </span><span style="color:#89DDFF;--shiki-dark:#F97583">%</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> length</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">]();</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#125;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>Well, that code is strange. It’s because I’ve generated all actual invocations of factory provider using <strong>T4</strong> template file. Obviously that isn’t necessary, but as soon as I generated all code for clients using the same T4 templates, I thought that it is more maintainable to generate invocations as well. I mentioned it before, but all code is available on GitHub, so you may have a look at <a href="https://github.com/AxelUser/examples/blob/master/DotNet/DictionaryOfTypes/Clients/StubbedClients.cs" rel="nofollow">generated clients</a> and generated <a href="https://github.com/AxelUser/examples/blob/master/DotNet/DictionaryOfTypes/Benchmarking/BenchmarkCallsCreator.cs" rel="nofollow">provider invocations</a>.</p> <p>One more thing to know - because I don’t want to include the creation of delegates with provider invocations, it’s vital to move it into set-up, similar to the one that testing frameworks offer. BenchmarkDotNet has the same API for it, which means making set-up method and marking it with <a href="https://benchmarkdotnet.org/articles/features/setup-and-cleanup.html" rel="nofollow"><code>GlobalSetup</code></a> attribute:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">[</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">GlobalSetup</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">]</span></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#89DDFF;--shiki-dark:#F97583"> void</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> SetUp</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">()</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#BABED8;--shiki-dark:#E1E4E8">    _simpleFactoryRunActions </span><span style="color:#89DDFF;--shiki-dark:#F97583">=</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> BenchmarkCallsCreator</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">CreateInvocations</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#F97583">new</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> SimpleClientFactoryProvider</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>Now all deletes are accessible from private field and its initialization won’t affect the results.</p> <p>Anyway, let’s run our benchmark and see how things are doing:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span>|                         Method | Accesses |           Mean |         Error |        StdDev | Ratio |      Gen 0 | Gen 1 | Gen 2 | Allocated |</span></span>
<span class="line"><span>|------------------------------- |--------- |---------------:|--------------:|--------------:|------:|-----------:|------:|------:|----------:|</span></span>
<span class="line"><span>| SimpleFactory_SequentialAccess |      100 |       3.636 us |     0.0297 us |     0.0278 us |  1.00 |     0.3815 |     - |     - |   2.34 KB |</span></span>
<span class="line"><span>|                                |          |                |               |               |       |            |       |       |           |</span></span>
<span class="line"><span>| SimpleFactory_SequentialAccess |     1000 |      38.098 us |     0.2838 us |     0.2654 us |  1.00 |     3.7842 |     - |     - |  23.44 KB |</span></span>
<span class="line"><span>|                                |          |                |               |               |       |            |       |       |           |</span></span>
<span class="line"><span>| SimpleFactory_SequentialAccess | 10000000 | 383,617.687 us | 3,106.0346 us | 2,905.3867 us |  1.00 | 38000.0000 |     - |     - | 234375 KB |</span></span></code></pre><!----> <p>We may see, that the provider performed quite fast (for now), but had allocated factory objects for each invocation of the factory provider. As I’ve said, for this issue there’s a solution - <strong>caching factories</strong>.</p> <h2 id="store-factories-into-dictionary"><a class="header-anchor" aria-hidden="true" tabindex="-1" href="#store-factories-into-dictionary">#</a>Store Factories into Dictionary</h2> <p>The most obvious way to cache concrete factories is to store mapping from interface to factory, not just the mapping between interfaces and their implementation.</p> <p>Seems legit! So let’s rewrite our initial factory method into one, which returns concrete client’s factories for interfaces.</p> <p>Mapping reflection-based mechanism also should be rewritten to store concrete client factories for each interface into static dictionary object. As mentioned above, this mapping can performed once at application start-up, because factories are quite stateless by themselves.</p> <p>Unfortunately, we can’t provide open generic type as the type for a value of our dictionary, but because all these factories are reference types, we can cast them to objects, put these values into the dictionary and when requested, receive from the dictionary and cast to a requested generic type. To make further examples simpler, I’ve extracted mapping construction into static helper <code>ClientTypesProvider.GetAllTypes(Assembly)</code>, because it won’t be changed further in the article.</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> CachedSimpleFactoryProvider</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">:</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IClientsFactoryProvider</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    private</span><span style="color:#C792EA;--shiki-dark:#F97583"> static</span><span style="color:#C792EA;--shiki-dark:#F97583"> readonly</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Type</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> FactoryType</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =</span><span style="color:#89DDFF;--shiki-dark:#F97583"> typeof</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">ClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;>);</span></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    private</span><span style="color:#C792EA;--shiki-dark:#F97583"> static</span><span style="color:#C792EA;--shiki-dark:#F97583"> readonly</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Dictionary</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">Type</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">,</span><span style="color:#89DDFF;--shiki-dark:#F97583"> object</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> CachedClientFactories</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    static</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> CachedSimpleFactoryProvider</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">()</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#123;</span></span>
<span class="line"><span style="color:#BABED8;--shiki-dark:#E1E4E8">        CachedClientFactories </span><span style="color:#89DDFF;--shiki-dark:#F97583">=</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> ClientTypesProvider</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">GetAllTypes</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">Assembly</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">GetExecutingAssembly</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">())</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">            .</span><span style="color:#82AAFF;--shiki-dark:#B392F0">ToDictionary</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">tuple</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> tuple</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">@interface</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">,</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> tuple</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span><span style="color:#82AAFF;--shiki-dark:#B392F0"> CreateFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">tuple</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">implementation</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">));</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    public</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span><span style="color:#82AAFF;--shiki-dark:#B392F0"> GetClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">>()</span><span style="color:#C792EA;--shiki-dark:#F97583"> where</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> :</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#123;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">        if</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#F97583">!</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">CachedClientFactories</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">TryGetValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#F97583">typeof</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">),</span><span style="color:#C792EA;--shiki-dark:#F97583"> out</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> factory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">))</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">            throw</span><span style="color:#89DDFF;--shiki-dark:#F97583"> new</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Exception</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">$"</span><span style="color:#C3E88D;--shiki-dark:#9ECBFF">Client type '</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">&#123;</span><span style="color:#89DDFF;--shiki-dark:#F97583">typeof</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">)&#125;</span><span style="color:#C3E88D;--shiki-dark:#9ECBFF">' isn't supported</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">"</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">        return</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> (</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">IClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">>)</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> factory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    private</span><span style="color:#C792EA;--shiki-dark:#F97583"> static</span><span style="color:#89DDFF;--shiki-dark:#F97583"> object</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> CreateFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">Type</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> clientType</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#123;</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#F97583">        var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> factory</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> FactoryType</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">MakeGenericType</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">clientType</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">        return</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> Activator</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">CreateInstance</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">factory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">,</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> clientType</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span><span style="color:#89DDFF;--shiki-dark:#F97583">!</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#125;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>Well, this solution isn’t so elegant, but <strong>casting is mostly used to overcome the type system’s limitation</strong>.</p> <p>Now it’s obvious that we’ve reduced memory consumption using pre-allocated factories, but what about speed?</p> <p>Let’s check the performance of this caching mechanism by writing a benchmark and compare results with the baseline:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span>|                         Method | Accesses |           Mean |         Error |        StdDev | Ratio | RatioSD |      Gen 0 | Gen 1 | Gen 2 |   Allocated |</span></span>
<span class="line"><span>|------------------------------- |--------- |---------------:|--------------:|--------------:|------:|--------:|-----------:|------:|------:|------------:|</span></span>
<span class="line"><span>| SimpleFactory_SequentialAccess |      100 |       3.636 us |     0.0152 us |     0.0142 us |  1.00 |    0.00 |     0.3815 |     - |     - |      2400 B |</span></span>
<span class="line"><span>| CachedFactory_SequentialAccess |      100 |       7.692 us |     0.0543 us |     0.0481 us |  2.12 |    0.01 |          - |     - |     - |           - |</span></span>
<span class="line"><span>|                                |          |                |               |               |       |         |            |       |       |             |</span></span>
<span class="line"><span>| SimpleFactory_SequentialAccess |     1000 |      35.619 us |     0.0787 us |     0.0697 us |  1.00 |    0.00 |     3.7842 |     - |     - |     24001 B |</span></span>
<span class="line"><span>| CachedFactory_SequentialAccess |     1000 |      74.106 us |     0.9672 us |     0.9047 us |  2.08 |    0.03 |          - |     - |     - |         1 B |</span></span>
<span class="line"><span>|                                |          |                |               |               |       |         |            |       |       |             |</span></span>
<span class="line"><span>| SimpleFactory_SequentialAccess | 10000000 | 365,822.213 us | 2,226.8696 us | 2,083.0152 us |  1.00 |    0.00 | 38000.0000 |     - |     - | 240000000 B |</span></span>
<span class="line"><span>| CachedFactory_SequentialAccess | 10000000 | 746,398.580 us | 3,361.2568 us | 3,144.1217 us |  2.04 |    0.02 |          - |     - |     - |           - |</span></span></code></pre><!----> <p>Hm, seems like it’s <strong>became SLOWER, than the original simple solution</strong>, but we may guess what operation caused such performance penalty. <em>Did we write something wrong or inefficient?</em></p> <p>Earlier I’ve mentioned that “dumb” casting from object to generic factory type. <strong>This simple cast is overkill for current situation</strong> - it involves type checking, but we know exactly what generic type stored under each key in dictionary.</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span><span style="color:#82AAFF;--shiki-dark:#B392F0"> GetClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">>()</span><span style="color:#C792EA;--shiki-dark:#F97583"> where</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> :</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">    if</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#F97583">!</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">CachedClientFactories</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">TryGetValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#F97583">typeof</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">),</span><span style="color:#C792EA;--shiki-dark:#F97583"> out</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> factory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">))</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">        throw</span><span style="color:#89DDFF;--shiki-dark:#F97583"> new</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Exception</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">$"</span><span style="color:#C3E88D;--shiki-dark:#9ECBFF">Client type '</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">&#123;</span><span style="color:#89DDFF;--shiki-dark:#F97583">typeof</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">)&#125;</span><span style="color:#C3E88D;--shiki-dark:#9ECBFF">' isn't supported</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">"</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">    return</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> Unsafe</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">As</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">IClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">>>(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">factory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>Once again check the benchmark results:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span>|                         Method | Accesses |           Mean |         Error |        StdDev | Ratio |      Gen 0 | Gen 1 | Gen 2 |   Allocated |</span></span>
<span class="line"><span>|------------------------------- |--------- |---------------:|--------------:|--------------:|------:|-----------:|------:|------:|------------:|</span></span>
<span class="line"><span>| SimpleFactory_SequentialAccess |      100 |       3.492 us |     0.0143 us |     0.0134 us |  1.00 |     0.3815 |     - |     - |      2400 B |</span></span>
<span class="line"><span>| CachedFactory_SequentialAccess |      100 |       3.138 us |     0.0022 us |     0.0020 us |  0.90 |          - |     - |     - |           - |</span></span>
<span class="line"><span>|                                |          |                |               |               |       |            |       |       |             |</span></span>
<span class="line"><span>| SimpleFactory_SequentialAccess |     1000 |      34.968 us |     0.3702 us |     0.3462 us |  1.00 |     3.7842 |     - |     - |     24000 B |</span></span>
<span class="line"><span>| CachedFactory_SequentialAccess |     1000 |      31.494 us |     0.0589 us |     0.0522 us |  0.90 |          - |     - |     - |           - |</span></span>
<span class="line"><span>|                                |          |                |               |               |       |            |       |       |             |</span></span>
<span class="line"><span>| SimpleFactory_SequentialAccess | 10000000 | 369,860.373 us | 2,062.8473 us | 1,929.5887 us |  1.00 | 38000.0000 |     - |     - | 240000000 B |</span></span>
<span class="line"><span>| CachedFactory_SequentialAccess | 10000000 | 306,086.300 us | 2,633.7588 us | 2,463.6196 us |  0.83 |          - |     - |     - |           - |</span></span></code></pre><!----> <p>Much better - the speed of invocation is a little bit less than the baseline and the memory consumption is minimal.</p> <p>We may stay with this implementation, but if that was an option, I’ve never wrote such an obvious post 😅.</p> <p>So, is there a way to improve speed even more? Well, <strong>that’s when generics steal the show!</strong></p> <h2 id="delegate-caching-to-jit"><a class="header-anchor" aria-hidden="true" tabindex="-1" href="#delegate-caching-to-jit">#</a>Delegate Caching to JIT</h2> <p>This trick is mostly inspired by the way how <a href="https://docs.microsoft.com/en-us/dotnet/api/system.array.empty?view=netcore-3.1" rel="nofollow">Array.Empty</a> works.</p> <p>Empty arrays are best candidates for caching, because their construction doesn’t require any parameters, but only a generic type parameter.</p> <p>When you invoke <code>Array.Empty&lt;MyClass></code>, it internally invokes a static read-only field <code>Empty</code> of static generic class <code>EmptyArray&lt;MyClass></code>, which initializes and returns an empty array of type <code>MyClass</code> (have a look at <a href="https://github.com/dotnet/runtime/blob/3705185af806e273ccef98e44699400f0416c452/src/libraries/System.Private.CoreLib/src/System/Array.cs#L694-L704" rel="nofollow">sources</a>). Static field is initialized during the time of a first access to the field of the class <em>EmptyArray</em>. This is guaranteed from the fact how generics and static classes work in <strong>CLR</strong> (Common Language Runtime). For your information, that’s how you can implement a <a href="https://csharpindepth.com/articles/singleton" rel="nofollow">simple thread-safe singleton</a> in .Net.</p> <h2 id="how-clr-compiles-generic-classes"><a class="header-anchor" aria-hidden="true" tabindex="-1" href="#how-clr-compiles-generic-classes">#</a>How CLR Compiles Generic Classes</h2> <p>Generics are types, that contain a type parameter, which isn’t known at compile time (e.g. <code>List&lt;T></code>). When dotnet compiler sees open generic type, it compiles it into IL with the same generic type parameter.</p> <p>After the type argument is passed into generic constructor (e.g. <code>List&lt;MyClass></code>), CLR will do the following:</p> <ol><li>Lookup if the closed generic (with concrete generic type argument) was requested before.</li> <li>If not - it will be compiled at run time.</li></ol> <p>Nice point is that JIT compiler will share all code for specific generics, which have only reference types as their type parameters. This optimization makes sense, because objects of reference types are passed into methods by fixed-sized reference to their content in the managed heap. All references to objects have common size, which equals to the machine word: 32 or 64 bits, depending on the architecture of an operating system and processor.</p> <p>It doesn’t mean, that compiler vanishes all information about different closed generics, but instead of compiling the whole code for the class, it will save the information about concrete closed generic into <strong>Method Table</strong>.</p> <p>It worth mentioning, that for value types, like structs and primitives, JIT will compile specialized code to handle each type parameters combination, which were passed during the construction of a closed generic.</p> <p>Using the knowledge about how generics are compiled and how static fields are initialized, we can implement a cache for factory producer.</p> <h2 id="implementing-a-generic-based-cached-producer"><a class="header-anchor" aria-hidden="true" tabindex="-1" href="#implementing-a-generic-based-cached-producer">#</a>Implementing a Generic-Based Cached Producer</h2> <p>Let’s create a new static class <code>CachedFactory&lt;T></code> with static field <code>Instance</code>, which is initialized with a factory for the concrete client implementing interface <em>T</em>. The factory creation is extracted into the method, that gets implementation type from static dictionary and creates a factory.</p> <p>How new static factories can access the mapping information? One way is to make that dictionary public, as well as making this new class as public. However, as I mentioned before in the case of dictionary-based caching solution, that will pollute a namespace with things you should never access manually.</p> <p>Encapsulation of the caching mechanism can be achieved by making the class <code>CachedFactory&lt;T></code> private and nesting it inside the actual provider class. In that case the public factory provider will have full access the public field of <code>CachedFactory&lt;T></code>, without opening its API to the outer code</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#C792EA;--shiki-dark:#F97583"> partial</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> GenericClientFactoryProvider</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    private</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> CachedFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span><span style="color:#C792EA;--shiki-dark:#F97583"> where</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> :</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#123;</span></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">        public</span><span style="color:#C792EA;--shiki-dark:#F97583"> static</span><span style="color:#C792EA;--shiki-dark:#F97583"> readonly</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">>?</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Instance</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">        static</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> CachedFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">()</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">        &#123;</span></span>
<span class="line"><span style="color:#BABED8;--shiki-dark:#E1E4E8">            Instance </span><span style="color:#89DDFF;--shiki-dark:#F97583">=</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> CreateFactoryIfAllowed</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">        &#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">        private</span><span style="color:#C792EA;--shiki-dark:#F97583"> static</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">>?</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> CreateFactoryIfAllowed</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">()</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span></span>
<span class="line"><span style="color:#BABED8;--shiki-dark:#E1E4E8">            DiscoveredAllowedClientTypes</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">TryGetValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#F97583">typeof</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">),</span><span style="color:#C792EA;--shiki-dark:#F97583"> out</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> implType</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#F97583">                ?</span><span style="color:#89DDFF;--shiki-dark:#F97583"> new</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> ClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">>(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">implType</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#F97583">                :</span><span style="color:#89DDFF;--shiki-dark:#79B8FF"> null</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#125;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>However, there is also a caveat - <strong>when a type <em>T</em> isn’t stored in dictionary, the generic nevertheless will be compiled and stored at Method Table until the end of execution</strong>. That’s why the whole generics trick may be a bad idea, if the client interface is passed from user input.</p> <p>To make things a little bit fancier, <strong>code with nested class may be extracted into own file</strong>, if the factory provider will be marked as partial. It’s up to you how to name that file, but I recommend you to write the name of the provider plus the name of cached factory, separated by the dot, like <em>GenericClientFactoryProvider.CachedFactory.cs</em>.</p> <p>Provider will trigger client creation when accessing the field <code>Instance</code> of a closed generic <code>CachedFactory&lt;T></code> class for the first time:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">public</span><span style="color:#C792EA;--shiki-dark:#F97583"> partial</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> GenericClientFactoryProvider</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> :</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IClientsFactoryProvider</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    private</span><span style="color:#C792EA;--shiki-dark:#F97583"> static</span><span style="color:#C792EA;--shiki-dark:#F97583"> readonly</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Dictionary</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">Type</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">,</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Type</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> DiscoveredAllowedClientTypes</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    public</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> IClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">></span><span style="color:#82AAFF;--shiki-dark:#B392F0"> GetClientFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">>()</span><span style="color:#C792EA;--shiki-dark:#F97583"> where</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> :</span><span style="color:#FFCB6B;--shiki-dark:#F97583"> class</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#123;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">        return</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> CachedFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">>.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">Instance </span><span style="color:#89DDFF;--shiki-dark:#F97583">??</span><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit"> throw</span><span style="color:#89DDFF;--shiki-dark:#F97583"> new</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> Exception</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">$"</span><span style="color:#C3E88D;--shiki-dark:#9ECBFF">Client type '</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">&#123;</span><span style="color:#89DDFF;--shiki-dark:#F97583">typeof</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">T</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">)&#125;</span><span style="color:#C3E88D;--shiki-dark:#9ECBFF">' isn't supported</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">"</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">    static</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> GenericClientFactoryProvider</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">()</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#123;</span></span>
<span class="line"><span style="color:#BABED8;--shiki-dark:#E1E4E8">        DiscoveredAllowedClientTypes </span><span style="color:#89DDFF;--shiki-dark:#F97583">=</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> ClientTypesProvider</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">GetAllTypes</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">Assembly</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">GetExecutingAssembly</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">())</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">            .</span><span style="color:#82AAFF;--shiki-dark:#B392F0">ToDictionary</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">tuple</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> tuple</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">@interface</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">,</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> tuple</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> tuple</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">implementation</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#125;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>If client creation shouldn’t be lazy, fields for all closed generic classes can be accessed at the same time, when mapping is created.</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">static</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> GenericClientFactoryProvider</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">()</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#BABED8;--shiki-dark:#E1E4E8">    DiscoveredAllowedClientTypes </span><span style="color:#89DDFF;--shiki-dark:#F97583">=</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> ClientTypesProvider</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">GetAllTypes</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">Assembly</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">GetExecutingAssembly</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">())</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">        .</span><span style="color:#82AAFF;--shiki-dark:#B392F0">ToDictionary</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">tuple</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> tuple</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">@interface</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">,</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> tuple</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =></span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> tuple</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">implementation</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;--shiki-dark:#B392F0">    InitializeFactories</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">();</span><span style="color:#676E95;font-style:italic;--shiki-dark:#6A737D;--shiki-dark-font-style:inherit"> // Eager initialization</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;--shiki-dark:#F97583">private</span><span style="color:#C792EA;--shiki-dark:#F97583"> static</span><span style="color:#89DDFF;--shiki-dark:#F97583"> void</span><span style="color:#82AAFF;--shiki-dark:#B392F0"> InitializeFactories</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">()</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#123;</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#F97583">    var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> factory</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =</span><span style="color:#89DDFF;--shiki-dark:#F97583"> typeof</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#FFCB6B;--shiki-dark:#B392F0">CachedFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#x3C;>);</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit">    foreach</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8"> (</span><span style="color:#FFCB6B;--shiki-dark:#F97583">var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> @interface</span><span style="color:#89DDFF;font-style:italic;--shiki-dark:#F97583;--shiki-dark-font-style:inherit"> in</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> DiscoveredAllowedClientTypes</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">Keys</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#123;</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#F97583">        var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> genericFactory</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> factory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">MakeGenericType</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#BABED8;--shiki-dark:#E1E4E8">@interface</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#FFCB6B;--shiki-dark:#F97583">        var</span><span style="color:#FFCB6B;--shiki-dark:#B392F0"> instanceProperty</span><span style="color:#89DDFF;--shiki-dark:#F97583"> =</span><span style="color:#BABED8;--shiki-dark:#E1E4E8"> genericFactory</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">GetField</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">"</span><span style="color:#C3E88D;--shiki-dark:#9ECBFF">Instance</span><span style="color:#89DDFF;--shiki-dark:#9ECBFF">"</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#BABED8;--shiki-dark:#E1E4E8">        instanceProperty</span><span style="color:#89DDFF;--shiki-dark:#F97583">!</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">.</span><span style="color:#82AAFF;--shiki-dark:#B392F0">GetValue</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">(</span><span style="color:#89DDFF;--shiki-dark:#79B8FF">null</span><span style="color:#89DDFF;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">    &#125;</span></span>
<span class="line"><span style="color:#89DDFF;--shiki-dark:#E1E4E8">&#125;</span></span></code></pre><!----> <p>Now let’s add a new benchmark and check the performance:</p> <!----><pre class="shiki shiki-themes material-theme-palenight github-dark" style="background-color:#292D3E;--shiki-dark-bg:#24292e;color:#babed8;--shiki-dark:#e1e4e8" tabindex="0"><code><span class="line"><span>|                                  Method | Accesses |           Mean |         Error |        StdDev | Ratio |      Gen 0 | Gen 1 | Gen 2 |   Allocated |</span></span>
<span class="line"><span>|---------------------------------------- |--------- |---------------:|--------------:|--------------:|------:|-----------:|------:|------:|------------:|</span></span>
<span class="line"><span>|          SimpleFactory_SequentialAccess |      100 |       3.538 us |     0.0454 us |     0.0402 us |  1.00 |     0.3815 |     - |     - |      2400 B |</span></span>
<span class="line"><span>|          CachedFactory_SequentialAccess |      100 |       3.213 us |     0.0233 us |     0.0218 us |  0.91 |          - |     - |     - |           - |</span></span>
<span class="line"><span>| CompiledGenericFactory_SequentialAccess |      100 |       1.390 us |     0.0128 us |     0.0107 us |  0.39 |          - |     - |     - |           - |</span></span>
<span class="line"><span>|                                         |          |                |               |               |       |            |       |       |             |</span></span>
<span class="line"><span>|          SimpleFactory_SequentialAccess |     1000 |      36.258 us |     0.1383 us |     0.1294 us |  1.00 |     3.7842 |     - |     - |     24000 B |</span></span>
<span class="line"><span>|          CachedFactory_SequentialAccess |     1000 |      31.292 us |     0.1065 us |     0.0890 us |  0.86 |          - |     - |     - |           - |</span></span>
<span class="line"><span>| CompiledGenericFactory_SequentialAccess |     1000 |      14.505 us |     0.0144 us |     0.0120 us |  0.40 |          - |     - |     - |           - |</span></span>
<span class="line"><span>|                                         |          |                |               |               |       |            |       |       |             |</span></span>
<span class="line"><span>|          SimpleFactory_SequentialAccess | 10000000 | 374,137.631 us | 1,675.7705 us | 1,399.3442 us |  1.00 | 38000.0000 |     - |     - | 240000000 B |</span></span>
<span class="line"><span>|          CachedFactory_SequentialAccess | 10000000 | 307,281.414 us | 1,939.4985 us | 1,719.3149 us |  0.82 |          - |     - |     - |           - |</span></span>
<span class="line"><span>| CompiledGenericFactory_SequentialAccess | 10000000 | 144,997.830 us |   715.7528 us |   634.4962 us |  0.39 |          - |     - |     - |       334 B |</span></span></code></pre><!----> <p>Speed of invocation has been dramatically increased, compared to the previous dictionary-based solution. Now we may use this solution with interface defined earlier, gaining all benefits of generic type lookup, which give us the runtime itself.</p> <h2 id="conclusion"><a class="header-anchor" aria-hidden="true" tabindex="-1" href="#conclusion">#</a>Conclusion</h2> <p>All these solutions are powered by the knowledge of runtime internals, which may increase the difficulty of understanding how much benefits we receive. <strong>When messing with such hacks don’t hesitate to check the performance incrementally via benchmarking</strong>. I hope that my examples proves you, that this process isn’t much harder than writing a unit-tests, thanks to BenchmarkDotNet!</p> <p>All provided solutions are quite specialized for the task of caching values, which don’t depend on dynamic parameters. In other words all values can be initialized during the application start-up. If that is your case, you may use provided solutions and I hope you will improve the overall performance of your program.</p> <h2 id="references"><a class="header-anchor" aria-hidden="true" tabindex="-1" href="#references">#</a>References</h2> <ol><li><a href="https://codeblog.jonskeet.uk/2017/04/26/surprise-creating-an-instance-of-an-open-generic-type/" rel="nofollow">How to create open generic type at runtime</a></li> <li><a href="https://alexandrnikitin.github.io/blog/dotnet-generics-under-the-hood/" rel="nofollow">Generic types under the hood</a></li> <li><a href="https://benchmarkdotnet.org/" rel="nofollow">BenchmarkDotNet website</a></li></ol><!----></div> <footer class="post-footer svelte-1dc6gs2"><div class="post-navigation svelte-1dc6gs2"><!--[--><a href="/blog" class="button primary medium svelte-1edpa7d"><!---->← Back to all posts<!----></a><!--]--><!----></div> <!--[!--><!--]--> <div class="card default svelte-1f4837s"><!--[!--><!--]--> <div class="card-content svelte-1f4837s"><div class="share-message svelte-1dc6gs2">Enjoyed this post? Share it with the universe!</div> <div class="share-buttons svelte-1dc6gs2"><a class="link default share-link twitter svelte-blzdii" target="_blank" rel="noopener noreferrer" href="https://twitter.com/intent/tweet?text=Unlocking%20the%20Power%20of%20Generics%3A%20Simulating%20Dictionary%20Behavior%20in%20C%23&amp;url=" aria-label="Share on Twitter"><!---->Twitter<!----> <!--[!--><!--]--></a><!----> <a class="link default share-link linkedin svelte-blzdii" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/shareArticle?mini=true&amp;title=Unlocking%20the%20Power%20of%20Generics%3A%20Simulating%20Dictionary%20Behavior%20in%20C%23&amp;url=" aria-label="Share on LinkedIn"><!---->LinkedIn<!----> <!--[!--><!--]--></a><!----> <a class="link default share-link facebook svelte-blzdii" target="_blank" rel="noopener noreferrer" href="https://www.facebook.com/sharer/sharer.php?u=" aria-label="Share on Facebook"><!---->Facebook<!----> <!--[!--><!--]--></a><!----></div><!----></div> <!--[!--><!--]--></div><!----></footer></article> <!--[--><div class="referenced-posts svelte-1dc6gs2"><h2 class="svelte-1dc6gs2">Want to read more?</h2> <div class="posts-grid svelte-1xu41xx"><!--[--><a href="/blog/012-simd-within-a-register-how-i-doubled-hash-table-lookup-performance" class="content-card-link svelte-1e8k5qp"><div class="card neon clickable content-card svelte-1f4837s"><!--[--><!--[!--><!--]--> <!--[!--><picture class="svelte-1f4837s"><!--[--><source srcset="/_app/immutable/assets/hero.CAYiYJgd.avif 1x, /_app/immutable/assets/hero.2A24B_Gh.avif 2x" sizes="min(800px, 30vw)" type="image/avif" class="svelte-1f4837s"><source srcset="/_app/immutable/assets/hero.VTA5Cz52.webp 1x, /_app/immutable/assets/hero.Cvegwbyq.webp 2x" sizes="min(800px, 30vw)" type="image/webp" class="svelte-1f4837s"><source srcset="/_app/immutable/assets/hero.Blfknt1o.jpg 1x, /_app/immutable/assets/hero.CvtWwOfE.jpg 2x" sizes="min(800px, 30vw)" type="image/jpeg" class="svelte-1f4837s"><!--]--> <img src="/_app/immutable/assets/hero.CvtWwOfE.jpg" loading="lazy" class="cover-image real-image svelte-1f4837s" width="1536" height="1024" onload="this.__e=event" onerror="this.__e=event"></picture><!--]--><!--]--> <div class="card-content svelte-1f4837s"><!--[!--><!--]--> <div class="card-content svelte-1e8k5qp"><!--[--><span class="card-date svelte-1e8k5qp">2025-07-15</span><!--]--> <h3 class="card-title svelte-1e8k5qp">SIMD Within a Register: How I Doubled Hash Table Lookup Performance</h3> <p class="card-description svelte-1e8k5qp">It started with a simple thought: four bytes in a hash table bucket look just like an integer. Luckily, this one idea led to a deep dive into bit-twiddling and a 2x performance boost.</p> <!--[!--><!--]--> <!--[--><div class="card-tags svelte-1e8k5qp"><!--[--><span class="badge subtle small svelte-1ffaubh"><!---->Bitwise<!----></span><span class="badge subtle small svelte-1ffaubh"><!---->C#<!----></span><!--]--></div><!--]--></div><!----></div> <!--[--><div class="neon-border svelte-1f4837s"></div><!--]--></div><!----></a><a href="/blog/011-practical-bitwise-tricks-in-everyday-code" class="content-card-link svelte-1e8k5qp"><div class="card neon clickable content-card svelte-1f4837s"><!--[--><!--[!--><!--]--> <!--[!--><picture class="svelte-1f4837s"><!--[--><source srcset="/_app/immutable/assets/hero.u8BEqUl_.avif 1x, /_app/immutable/assets/hero.LFrqv3X0.avif 2x" sizes="min(800px, 30vw)" type="image/avif" class="svelte-1f4837s"><source srcset="/_app/immutable/assets/hero.CKxIXTle.webp 1x, /_app/immutable/assets/hero.DAVKIi1O.webp 2x" sizes="min(800px, 30vw)" type="image/webp" class="svelte-1f4837s"><source srcset="/_app/immutable/assets/hero.ZY5Je-2-.jpg 1x, /_app/immutable/assets/hero.xHvcAvrs.jpg 2x" sizes="min(800px, 30vw)" type="image/jpeg" class="svelte-1f4837s"><!--]--> <img src="/_app/immutable/assets/hero.xHvcAvrs.jpg" loading="lazy" class="cover-image real-image svelte-1f4837s" width="1536" height="1024" onload="this.__e=event" onerror="this.__e=event"></picture><!--]--><!--]--> <div class="card-content svelte-1f4837s"><!--[!--><!--]--> <div class="card-content svelte-1e8k5qp"><!--[--><span class="card-date svelte-1e8k5qp">2025-07-07</span><!--]--> <h3 class="card-title svelte-1e8k5qp">Practical Bitwise Tricks in Everyday Code</h3> <p class="card-description svelte-1e8k5qp">An opinionated and short collection of bitwise tricks that make sense at an average 1x engineer's code.</p> <!--[!--><!--]--> <!--[--><div class="card-tags svelte-1e8k5qp"><!--[--><span class="badge subtle small svelte-1ffaubh"><!---->Bitwise<!----></span><!--]--></div><!--]--></div><!----></div> <!--[--><div class="neon-border svelte-1f4837s"></div><!--]--></div><!----></a><!--]--></div><!----></div><!--]--><!----></div><!----><!----><!--]--><!----></main> <footer class="svelte-1mbgpkc"><div class="space-container undefined svelte-7gsxae"><p class="space-text-small">© 2025 | Aleksey Maltsev</p><!----></div><!----></footer><!----></div><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_13uvivk = {
						base: new URL("..", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.Bd13R3TE.js"),
						import("../_app/immutable/entry/app.Bi55SSnt.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 8],
							data: [null,{type:"data",data:{placeholderUrl:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAXCAYAAABqBU3hAAAMEElEQVR4AQCBAH7/AAAGBP8ABgT/AAcF/wAIBv8ACgj/Ag4M/wUSEP8KFhT/DRkX/w8bGf8QHBr/DxsZ/w0ZF/8LFxX/CRUT/wkVE/8KFxX/DhoY/xMfHf8YJCL/HCgm/x4qKP8fKyn/HSkn/xklI/8UIB7/DxsZ/wsXFf8HExH/BREP/wMPDf8DDw3/AIEAfv8AAAgG/wAIBv8ACAb/AAoI/wAMCv8DDw3/BxMR/wsXFf8OGhj/ER0b/xEdG/8QHBr/DhoY/wwYFv8KFhT/ChYU/wwYFv8PGxn/FCAe/xklI/8dKSf/Hysp/x8sKv8dKSf/GSYk/xUhH/8QHBr/CxcV/wgUEv8FEQ//BBAO/wMPDf8AgQB+/wAACgj/AAsJ/wALCf8ADAr/Ag4M/wUSEP8JFRP/DRkX/xEdG/8THx3/FCAe/xMfHf8RHRv/DxsZ/w0ZF/8NGRf/DhsZ/xIeHP8WIyH/Gycl/x8rKf8hLSv/IS0r/x8rKf8bJyX/FiIg/xEdG/8MGBb/CRUT/wYTEP8FEQ//BBEO/wCBAH7/AAIODP8CDw3/Aw8N/wQQDv8GEhD/CRUT/w0ZF/8RHRv/FCAe/xcjIf8XIyH/FiMh/xUhH/8SHx3/ER0b/xEdG/8SHx3/FiIg/xomJP8fKyn/Iy8t/yQxL/8kMC7/IS4s/x0pJ/8YJCL/Ex8d/w4bGP8LFxX/CRUT/wcTEf8HExH/AIEAfv8ABxQR/wcUEv8IFBL/CRUT/wsXFf8OGhj/ER4c/xUhH/8ZJSP/Gycl/xwoJv8bJyX/GSYk/xckIv8WIiD/FiIg/xgkIv8bJyX/Hysp/yQwLv8nMzH/KTUz/yg0Mv8lMS//IS0r/xsoJv8WIiD/Eh4c/w4aGP8MGBb/ChcV/woWFP8AgQB+/wANGRf/DRkX/w0aGP8OGxn/EBwa/xMfHf8XIyH/Gick/x4qKP8gLCr/IS0r/yAtK/8fKyn/HSkn/xwoJv8cKCb/Hioo/yEtK/8lMS//KTYz/y05N/8uOjj/LTk3/yo2NP8lMS//ICwq/xonJf8WIiD/Ex8d/xAcGv8PGxn/DxsZ/wCBAH7/ABMfHf8THx3/Ex8d/xQgHv8WIiD/GCUi/xwoJv8fLCr/Iy8t/yUxL/8mMjD/JjIw/yQxL/8jLy3/Ii4s/yIuLP8kMC7/JzMx/ys4Nv8vPDr/Mj89/zRAPv8yPzz/Lzs5/yo3NP8lMS//ICwq/xsnJf8YJCL/FiIg/xUhH/8UIB7/AIEAfv8AGCQi/xgkIv8YJSL/GSUj/xsnJf8dKSf/IS0r/yQwLv8nNDL/KjY0/ys3Nf8rNzX/KjY0/yg0Mv8nMzH/KDQy/yo2NP8tOTf/MT07/zVBP/84REL/OUVD/zhEQv80QT//MDw6/yo2NP8lMS//IS0r/x4qKP8cKCb/Gycl/xomJP8AgQB+/wAcKSf/HCgm/xwpJ/8dKSf/Hysp/yEtK/8kMC7/KDQy/ys3Nf8tOTf/Ljs5/y46OP8tOTf/LDg2/yw4Nv8sODb/Ljs5/zI+PP82QkD/OkZE/z1JR/8+Skj/PEhG/zlFQ/80QD7/Lzs5/yo2NP8mMjD/Iy8t/yEtK/8gLCr/ICwq/wCBAH7/AB8rKf8fKyn/Hysp/x8sKv8hLSv/Iy8t/yYyMP8qNjT/LTk3/y87Of8wPDr/MDw6/y87Of8uOjj/Ljo4/y87Of8xPTv/NUE//zlFQ/89SUf/QExK/0FNS/8/S0n/PEhG/zdDQf8yPjz/LTk3/yk1M/8nMzH/JTEv/yUxL/8kMS7/AIEAfv8AHywq/x8sKf8fLCn/ICwq/yEtK/8jLy3/JjIw/yk2NP8sOTf/Lzs5/zA8Ov8wPDr/Lzs5/y46OP8uOjj/Lzs5/zE9O/81QT//OUVD/z1JR/9ATEr/QU1L/0BMSv88SUf/OERC/zM/Pf8uOjj/Kzc1/yg1M/8nMzH/JzMx/yczMf8AgQB+/wAeKij/Hioo/x4qKP8eKij/Hywp/yEuLP8kMC7/JzMx/yo2NP8sODb/LTk3/y05N/8sODb/Kzc1/ys3Nf8sODb/Lzs5/zM/Pf83Q0H/O0dF/z5KSP8/S0n/PkpI/zpHRf82QkD/MT07/y05N/8qNjT/KDQy/yczMf8nMzH/JzMx/wCBAH7/ABsnJf8aJyX/Gick/xsnJf8cKCb/Hioo/yEtK/8jMC7/JjIw/yg0Mv8pNTP/KTUz/yg0Mv8nMzH/JjIw/yczMf8qNjT/Ljo4/zI+PP82Q0H/OUVD/zpGRP85RUP/NkJA/zI+PP8tOTf/KTUz/yYzMf8lMS//JDAu/yQwLv8kMC7/AIEAfv8AFiIg/xYiIP8WIiD/FiIg/xcjIf8ZJSP/HCgm/x4rKf8hLSv/Iy8t/yMvLf8jLy3/IS4r/yAsKv8gLCr/IS0r/yMwLv8nMzH/LDg2/zA8Ov8zPz3/NEA+/zM/Pf8wPDr/LDg2/yc0Mv8kMC7/IS0r/yAsKv8fKyn/Hysp/yAsKv8AgQB+/wAQHBr/EBwa/xAcGv8RHRv/Eh4c/xQgHv8WIiD/GSUj/xsnJf8dKSf/HSkn/xwoJv8bJyX/GSUj/xklI/8aJiT/HCgm/yAsKv8kMC7/KDUz/ys3Nf8sOTb/Kzc1/yk1M/8lMS//IC0r/x0pJ/8bJyX/GSUj/xklI/8ZJiP/GiYk/wCBAH7/AAsXFf8LFxX/CxcV/wwYFv8NGRf/DxsZ/xEdG/8UIB7/FiIg/xcjIf8XIyH/FiIg/xQgHv8THx3/Eh4c/xMfHf8VIR//GSUj/x0pJ/8hLSv/JDAu/yUxL/8kMC7/IS0r/x4qKP8aJiT/FiIg/xQgHv8THx3/Ex8d/xMfHf8UIB7/AIEAfv8ABhMQ/wYTEf8HExH/BxMR/wkVE/8LFxX/DRkX/xAcGv8SHhz/Ex8d/xIfHf8RHRv/DxsZ/w0ZF/8MGBb/DRkX/w8bGf8SHhz/FyMh/xsnJf8eKij/Hysp/x4qKP8bJyX/FyMh/xMgHv8QHBr/DhoY/w0ZF/8NGRf/DhoY/w4aGP8AgQB+/wADDw3/Aw8N/wMQDf8EEA7/BhIQ/wgUEv8KFxX/DRkX/w8bGf8QHBr/DxsZ/w4aGP8LFxX/CRUT/wgUEv8IFBL/ChYU/w4aGP8SHhz/FiIg/xklI/8aJiT/GSUj/xYjIf8THx3/DxsZ/wwYFv8KFhT/CRUT/wkVE/8KFhT/ChYU/wCBAH7/AAENC/8BDQv/AQ4M/wIPDf8EEA7/BhMR/wkVE/8MGBb/DhoY/w4bGP8OGhj/DBgW/wkWFP8HExH/BhIQ/wYSEP8IFBL/CxcV/w8bGf8THx3/FiIg/xcjIf8WIiD/FCAe/xAcGv8MGRf/CRUT/wcUEv8HExH/BxMR/wgUEv8IFBL/AIEAfv8AAAwK/wAMCv8BDQv/Ag4M/wQQDv8GEhD/CRUT/wwYFv8OGhj/DhoY/w4aGP8MGBb/CRUT/wYTEf8FEQ//BREP/wcTEf8KFhT/DhoY/xIeHP8VIR//FiIg/xUhH/8THx3/DxsZ/wsYFv8IFRP/BxMR/wYSEP8GEhD/BxMR/wcTEf8AgQB+/wAADAr/AAwK/wENC/8CDgz/BBAO/wcTEf8KFhT/DBkX/w4bGf8PGxn/DhoY/wwYFv8JFhT/BxMR/wURD/8FEQ//BxMR/woWFP8OGhj/Eh4c/xUhH/8WIiD/FSIg/xMfHf8PGxn/DBgW/wkVE/8HExH/BhIQ/wYTEf8HExH/CBQS/wCBAH7/AAAMCv8ADQv/AQ0L/wMPDf8FEQ//CBQS/wsXFf8NGhj/DxwZ/xAcGv8PGxn/DRkX/woWFP8IFBL/BhIQ/wYSEP8HFBL/CxcV/w8bGf8THx3/FiIg/xcjIf8WIiD/EyAe/xAcGv8MGBb/CRUT/wcUEv8HExH/BxMR/wgUEv8IFRP/AYEAfv8AAAwK/wENC/8CDgz/Aw8N/wURD/8IFBL/CxcV/w4aGP8QHBr/ER0b/xAcGv8OGhj/CxcV/wgUEv8GEhD/BhIQ/wgUEv8LFxX/DxsZ/xMfHf8WIiD/FyMh/xYjIf8UIB7/EB0b/w0ZF/8KFhT/CBQS/wcUEv8IFBL/CBUT/wkVE//t8/BIVKP1LAAAAABJRU5ErkJggg==",views:29,ogImagePath:"/images/og/005-dictionary-on-generics.jpg"},uses:{params:["slug"]}}],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
